---
title: "Simulation Study"
output:
  pdf_document: default
  html_document: default
date: "2024-06-03"
---



```{r}
# install.packages(c('stringi', 'stringr', "MASS", "mstate", "survival", "ggplot2", "gridExtra", "reshape2", "reshape", "data.table", "scales", "doParallel", "foreach", "parallel", "mvtnorm", "dplyr", "pracma","glmnet"))

# install.packages(c("mstate", "gridExtra", "reshape2", "reshape", "doParallel", "foreach", "mvtnorm", "pracma"))

library(MASS)
library(mstate)
library(survival)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(reshape)
library(data.table)
library(scales)
library(Matrix)
library(grid)
library(xtable)
library(doParallel)
library(foreach)
library(parallel)
library(data.table)
library(mvtnorm)
library(dplyr)
library(pracma)
library(tidyr)
library(patchwork)

Print_flug = FALSE
```

# Penalized function

```{r}
source('pen_survrrr.R')
```

# Function to generate covariate matrix, A,$\Gamma$ and B

```{r}
add_zeros <- function(matrix, percentage = 0.10) {
  total_components <- length(matrix)
  zeros_count <- floor(total_components * percentage)
  
  indexes <- 1:total_components
  
  zero_indexes <- sample(indexes, zeros_count)
  
  matrix[zero_indexes] <- 0
  
  return(matrix)
}
```

```{r}
simulate_Beta_matrix = function(p,r,k,case=1){
if (case == 1){
    #GENERATE A, \Gamma and B matrix
    #A matrix
    A_matrix <- matrix(NA, nrow = p, ncol = r)
    for (i in 1:r) {
      A_matrix [, i] <- runif(p, 0,1)
    }
    #Gamma matrix
    Gamma_matrix <- matrix(NA, nrow = k, ncol = r)
    for (i in 1:r) {
      Gamma_matrix [, i] <- runif(k, 0,1)
    }

}
  else if(case ==2){
    if (p %% 2 != 0) {
      stop("p must be an even number")
    }
    #GENERATE A, \Gamma and B matrix
    #A matrix (1|0;0|1)
    A_matrix <- matrix(NA, nrow = p, ncol = r)
    for (i in 1:r/2) {
      A_matrix [, i] <- c(runif(p/2, 0,1),rep(0,p/2))
    }
    for (i in (r/2+1):r) {
      A_matrix [, i] <- c(rep(0,p/2),runif(p/2, 0,1))
    }
    #Gamma matrix (1|0;0|1)
    Gamma_matrix <- matrix(NA, nrow = k, ncol = r)
    for (i in 1:r/2) {
      Gamma_matrix [, i] <- c(runif(k/2, 0,1),rep(0,k/2))
    }
    for (i in (r/2+1):r) {
      Gamma_matrix [, i] <- c(rep(0,k/2),runif(k/2, 0,1))
    }
  }
  
      else if(case ==3){
    #GENERATE A, \Gamma and B matrix
    #A matrix
    A_matrix <- matrix(NA, nrow = p, ncol = r)
    for (i in 1:r) {
      A_matrix [, i] <- runif(p, 0,1)
    }
    #Gamma matrix
    Gamma_matrix <- matrix(NA, nrow = k, ncol = r)
    for (i in 1:r) {
      Gamma_matrix [, i] <- runif(k, 0,1)
    }
    A_matrix <- add_zeros(A_matrix, percent = 0.10)
    Gamma_matrix <- add_zeros(Gamma_matrix, percent = 0.10)
    
      }
  
  #Coefficient matrix B (p x k)
  Beta_matrix = A_matrix %*% t(Gamma_matrix)

return(Beta_matrix/100)
}
```

# Function to simulate dataset

```{r}

simulate_data_redrank_model = function(Beta_matrix,n,corr=0){

p=nrow(Beta_matrix)
k=ncol(Beta_matrix)

#GENERATE covariate matrix X
if (corr ==0){
X <- matrix(NA, nrow = n, ncol = p)
#n random variables p times and place them in the matrix columns, to be uncorrelated
for (i in 1:p) {
  X[, i] <- rnorm(n, mean = 0, sd = 1)
}
} else if(corr>0){

  mean_vector <- rep(0, p)  # Mean vector
  correlation <- corr      # Desired correlation

  #covariance matrix with correlation 0.8
  covariance_matrix <- matrix(correlation, nrow = p, ncol = p)
  diag(covariance_matrix) <- 1  

  # Generate the matrix using rmvnorm
  X <- rmvnorm(n, mean = mean_vector, sigma = covariance_matrix)
  
  if (Print_flug == TRUE){
  print(X)
    print(cor(X))
    }
}

#GENERATE T(times)
# later: mean_age = 60 
# Linear predictors
eta <- X %*% Beta_matrix
exp_eta=exp(eta)
exp_eta[exp_eta <= 1e-300] <- 1e-300 

# Outcome times T from exp distribution
T <- matrix(NA, nrow = n, ncol = k)
for (i in 1:k) {
   T[, i] <- rexp(n, rate =  exp_eta[,i])
}

#GENERATE censoring 
#Random censoring time from Uniform distribution
C <- runif(n, min = 0, max = 1)

#DETERMINE the observed time and censoring indicator
T_obs <- pmin(T, C)
delta <- as.integer(T <= C)  # 1 if the event occurred, 0 if censored
# Check the proportion of censored vs event occurrences
prop_censored <- sum(delta == 0)/n/k
prop_event <- sum(delta == 1)/n/k
# Output proportions 

if (Print_flug == TRUE){
print(paste('Proportion of no events',prop_censored))
print(paste('Proportion of events',prop_event))
}

#CREATE matrix with data for each outcome
observed_times = T_obs
event = matrix(delta,n,k)


#CREATE data frame
data <- data.frame(id = 1:n)
for (i in 1:k) {
  data[[paste0("t", i)]] <- observed_times[, i]
  data[[paste0("d", i)]] <- event[, i]
}
# Add predictors 
for (i in 1:p) {
  data[[paste0("x", i)]] <- X[, i]
}

return (list(
    data = data,
    X=X,
    T_sim=T,
    T_obs=T_obs
  ))
}
```

# Function to preprocess data to be ready to enter the redrank model

```{r}

preprocess_data_redrank_model = function(data,k){

#subjects
n <- nrow(data)

# Transition matrix(k outcomes)
tmat <- trans.comprisk(k)

# Column names for survival times and event indicators
tnames <- paste("t", 1:k, sep="")
dnames <- paste("d", 1:k, sep="")

# Create dlong
dlong <- data.frame(
  id = rep(data$id, each = k),
  Tstart = 0,
  Tstop = c(t(matrix(unlist(c(data[, tnames])), n, k))),
  status = c(t(matrix(unlist(c(data[, dnames])), n, k))),
  from = 1,
  to = rep(2:(k+1), n),
  trans = rep(1:k, n)
)

#add predicotrs
predictor_names <- grep("^x", names(data), value = TRUE)
# Add each predictor to the dlong data frame
for (predictor in predictor_names) {
  dlong[[predictor]] <- rep(data[[predictor]], each = k)
}

# Calculate the time
dlong$time <- dlong$Tstop - dlong$Tstart

# Define the transition matrix and class
class(dlong) <- c("msdata", "data.frame")
attr(dlong, "trans") <- tmat

return(dlong)
}
```

# Function to chek performance of given model

```{r}
performance_redrank_model=function(Beta_matrix, model, X, Print_flug) {
  
estimated_Gamma <- model$Gamma
estimated_Alpha = model$Alpha
estimated_Beta <- estimated_Alpha %*% estimated_Gamma


estimated_eta = X %*% estimated_Beta
real_eta =X  %*% Beta_matrix
cor_lp=cor(as.vector(estimated_eta),as.vector(real_eta))
K=dim(estimated_eta)[2]
lp_errors = rowSums((estimated_eta - real_eta)^2)/K
ave_lp_error = mean(lp_errors)
      
estimated_coefficients <- estimated_Beta   
true_coefficients <- Beta_matrix 

#correlation coeff
cor_coeff = cor(as.vector(estimated_Beta),as.vector(true_coefficients))
# Each coefficient separately
# bias
bias <- (estimated_coefficients - true_coefficients)
# MSE
mse<- (estimated_coefficients - true_coefficients)^2


bias_each_coeff = mean(abs(bias))
mse_each_coeff = mean(mse)

if (Print_flug == TRUE){
print(paste('Mean bias takihg each coeff seperatly',bias_each_coeff))
print(paste('Mean mse taking each coeff seperatly',mse_each_coeff))
}


#For each outcome separately

b_pred=c()
for (i in 1:k){
  b_pred[i] = mean(estimated_coefficients[,i]-true_coefficients[,i])
  if (Print_flug == TRUE){
  print(paste('Mean bias for outcome',i,': ',b_pred[i]))
  }
}
mse_pred=c()
for (i in 1:k){
  mse_pred[i] = mean((estimated_coefficients[,i]-true_coefficients[,i])^2)
  if (Print_flug == TRUE){
  print(paste('Mean mse for outcome',i,': ',mse_pred[i]))
  }
}


return(list(
    bias_out = bias_each_coeff,
    mse_out = mse_each_coeff,
    b_pred = b_pred,
    mse_pred = mse_pred,
    cor_coeff = cor_coeff,
    bias_for_all_coeffs = bias,
    mse_for_all_coeffs = mse,
    lp_errors = lp_errors,
    cor_lp=cor_lp,
    eta_est=estimated_eta,
    eta_true=real_eta,
    ave_lp_error=ave_lp_error
    
  ))

}
```

# Function to simulate n_simulation datasets of given rank r

```{r}
simulations_data = function(n,p,r,k,n_simulations,case=1,corr=0){
  
Beta_matrix = simulate_Beta_matrix(p,r,k,case)

dlong_list <- vector("list", n_simulations)

X_list <- vector("list", n_simulations)

T_sim_list <- vector("list", n_simulations)
T_obs_list <- vector("list", n_simulations)

simulation_times = numeric(n_simulations)

for (i in 1:n_simulations){
  start_time = Sys.time()

  
  sim_data = simulate_data_redrank_model(Beta_matrix,n,corr)
  
  X_list[[i]] = sim_data$X
  
  T_sim_list[[i]]= sim_data$T_sim
  T_obs_list[[i]]= sim_data$T_obs

  data = sim_data$data
  
  
  dlong = preprocess_data_redrank_model(data,k)

  dlong_list[[i]] <- dlong
  
  end_time = Sys.time()  
  simulation_time = as.numeric(difftime(end_time, start_time, units = "secs"))  
  simulation_times[i] = simulation_time
  
  thresh = max(1,n_simulations/10)
  if ((i%%thresh) == 0){
    if (i==thresh){
    print(paste("Time for first", thresh, "datasets:", sum(simulation_times[1:thresh]), "seconds"))
    }
    else{
      print(paste("Time for datasets", (i - (thresh-1)), "to", i, ":", sum(simulation_times[(i - (thresh-1)):i]), "seconds"))
    }
  }
  
}

print(paste("Time for all", n_simulations, "simulations:", sum(simulation_times), "seconds"))

return(list( dlong_list = dlong_list,
             Beta_matrix = Beta_matrix,
             simulation_times = simulation_times,
             X_list=X_list,
             T_sim_list= T_sim_list,
             T_obs_list= T_obs_list))
}
```

# Function to fit data n_simulations times and access overall perforamnce


```{r}
simulations_fit_and_preformance = function(datas,p,k,R2,penalty_flug=FALSE,lambda_a=0,lambda_g=0, Gamma.start=0,Print_flug=FALSE,name='noth'){
  
n_simulations = length(datas$dlong_list)


cor_lp_=c()
ave_lp_error=c()
est_eta_list=list()
real_eta_list= list()
lp_errors_list=list()

    

bias1= c()
mse1= c()
cor_coeff_vec = c()

n_iter_list <- vector("list", n_simulations)

est_Gammamatrix_list = vector("list", n_simulations)
est_Alphamatrix_list = vector("list", n_simulations)

bias3_list <- vector("list", n_simulations)
mse3_list <- vector("list", n_simulations)

bias_for_all_coeffs = vector("list", n_simulations)
mse_for_all_coeffs = vector("list", n_simulations)

simulation_times = numeric(n_simulations)

Beta_matrix = datas$Beta_matrix
dlong_list = datas$dlong_list
  
file_name <- paste0("simulation_progress_exp",name, ".rds")

for (i in 1:n_simulations){
  start_time = Sys.time()

  
  dlong = dlong_list[[i]] 
  
  dlong <- dlong[dlong$Tstop > dlong$Tstart, ] 
  #to prevent Warning: Stop time must be > start time, NA createdError in response.coxnet(y) : NAs encountered in response, not allowed
 
  #construct formula for the model
  predictor_names <- grep("^x", names(dlong), value = TRUE)
  formula_str <- paste("Surv(Tstop, status) ~", paste(predictor_names, collapse = " + "))
  formula <- as.formula(formula_str)

  if (Print_flug == TRUE){
    if(penalty_flug==TRUE){
      model <-pen.survrrr(formula, dat = dlong, R = R2,Gamma.iter = Gamma.start, 
                eps = 1e-5, 
                lambda.alpha = lambda_a, 
                lambda.gamma = lambda_g,  
                standardize.opt = F,
                print_flug = Print_flug)

    }
    else{
      model <- redrank(formula, data = dlong, R = R2)
    }
  }
  else{
    if(penalty_flug==TRUE){
       model <- tryCatch({
        pen.survrrr(formula, dat = dlong, R = R2,Gamma.iter = Gamma.start, 
                eps = 1e-5, 
                lambda.alpha = lambda_a, 
                lambda.gamma = lambda_g, 
                standardize.opt = F,
                print_flug = Print_flug)
      }, 
      error = function(e) {
        cat("Error in dataset", i, ":", e$message, "\n")
        return(NULL)  # Return NULL if an error occurs
      })
       
       if (is.null(model)) next
       
    }
    else{
      model <- redrank(formula, data = dlong, R = R2,print.level = 0)
    }
  }
  
  #unpack estimated matrices 
  if(penalty_flug==TRUE){
  n_iter_list[[i]] = model$n_iter
  }
  else{
    n_iter_list[[i]] = model$niter
  }
  
  est_Gammamatrix_list[[i]] <-  model$Gamma
  est_Alphamatrix_list[[i]] <- model$Alpha
  
  
  result <- performance_redrank_model(Beta_matrix, model, datas$X_list[[1]], Print_flug)
  
  
  
   cor_lp_=c(cor_lp_,result$cor_lp)
   ave_lp_error=c(ave_lp_error,result$ave_lp_error)
   est_eta_list[[i]]=result$eta_est
   real_eta_list[[i]]= result$eta_true
   lp_errors_list[[i]]=result$lp_errors
  
  
  
  #unpack result
  
  bias1 = c(bias1, result$bias_out)
  mse1 = c(mse1, result$mse_out)
  
  bias3_list[[i]] <- result$b_pred
  mse3_list[[i]] <- result$mse_pred
  
  bias_for_all_coeffs[[i]] = result$bias_for_all_coeff
  mse_for_all_coeffs[[i]] = result$mse_for_all_coeffs
  
  cor_coeff_vec = c(cor_coeff_vec,result$cor_coeff)
  
  

  
  #Print time needed for each simulation
  end_time = Sys.time()  
  simulation_time = as.numeric(difftime(end_time, start_time, units = "secs"))  
  simulation_times[i] = simulation_time
  
  if(name!='noth'){
    saveRDS(list(
        bias1 = bias1,
        mse1 = mse1,
        cor_coeff_vec = cor_coeff_vec,
        simulation_times = simulation_times,
        est_Gammamatrix_list = est_Gammamatrix_list,
        est_Alphamatrix_list = est_Alphamatrix_list,
        n_iter_list = n_iter_list,
        bias3_list = bias3_list,
        mse3_list = mse3_list,
        bias_for_all_coeffs = bias_for_all_coeffs,
        mse_for_all_coeffs = mse_for_all_coeffs,
        cor_lp=cor_lp_,
       ave_lp_errors=ave_lp_error,
       eta_est=est_eta_list,
       eta_true= real_eta_list,
       lp_errors=lp_errors_list
      ), file = file_name)
  
  }
  
  thresh = max(1,n_simulations/10)
  if ((i%%thresh) == 0){
    if (i==thresh){
    print(paste("Time for first", thresh, "simulations:", sum(simulation_times[1:thresh]), "seconds"))
    }
    else{
      print(paste("Time for simulations", (i - (thresh-1)), "to", i, ":", sum(simulation_times[(i - (thresh-1)):i]), "seconds"))
    }
  }
  
}

print(paste("Time for all", n_simulations, "simulations:", sum(simulation_times), "seconds"))
# Convert the lists to data frames
bias3_df <- do.call(rbind, bias3_list)
mse3_df <- do.call(rbind, mse3_list)

# Name the columns as Outcome_1, Outcome_2, etc.
colnames(bias3_df) <- paste0("Outcome_", 1:k)
colnames(mse3_df) <- paste0("Outcome_", 1:k)

return(list(
    bias3_df = bias3_df,
    mse3_df = mse3_df,
    bias1 = bias1,
    mse1 = mse1,
    cor_coeff_vec = cor_coeff_vec,
    simulation_times = simulation_times,
    bias_for_all_coeffs_and_simulations = bias_for_all_coeffs,
    mse_for_all_coeffs_and_simulation = mse_for_all_coeffs,
    est_Gammamatrix_list=est_Gammamatrix_list,
    est_Alphamatrix_list=est_Alphamatrix_list,
    n_iter_list=n_iter_list,
   cor_lp=cor_lp_,
   ave_lp_errors=ave_lp_error,
   eta_est=est_eta_list,
   eta_true= real_eta_list,
   lp_errors=lp_errors_list
   
    ))

}

```



# Function to find Best lambda

```{r}
simulations_fit_find_best_lambda = function(datasets_list,lambda_vector,Gamma.start,p,k,R2,name='noth'){

n_iter_list = vector("list", length(datasets_list$dlong_list)*length(lambda_vector))
#to store estimated Gamma and Alpha for all datasets
est_Gammamatrix_list = vector("list", length(datasets_list$dlong_list)*length(lambda_vector))
est_Alphamatrix_list = vector("list", length(datasets_list$dlong_list)*length(lambda_vector))

#to store results for all datasets
results_df <- data.frame()

optimal_lambda_counts <- setNames(rep(0, length(lambda_vector)), lambda_vector)

n_simulations=length(datasets_list$dlong_list)
simulation_times = numeric(n_simulations)


file_name1 <- paste0("simulation_lambdas_expfulldataset",name, ".rds")

file_name2 <- paste0("simulation_lambdas_expnotfull",name, ".rds")

for (j in 1:length(datasets_list$dlong_list)) {
  datas <- list(
      dlong_list = datasets_list$dlong_list[j],
      Beta_matrix = datasets_list$Beta_matrix,
      simulation_times = datasets_list$simulation_times[j],
      X_list=datasets_list$X_list[j]
    )
  
  #to store results for each lambda in the current dataset
  results_list <- vector("list", length(lambda_vector))
  names(results_list) <- lambda_vector
  
  for (i in seq_along(lambda_vector)) {
    start_time = Sys.time()
    cat('dataset:',j,'lambda:',lambda_vector[i])
    lambda <- lambda_vector[i]
    #result <- simulations_fit_and_preformance(datas,p,k,R2,penalty_flug=TRUE,lambda_a=lambda,lambda_g=lambda, Gamma.start,Print_flug=FALSE)
    
    #handle errors and continue the loop
    result <- tryCatch({
        simulations_fit_and_preformance(datas, p, k, R2, penalty_flug = TRUE, lambda_a = lambda, lambda_g = lambda, Gamma.start, 
                                        Print_flug = Print_flug)
      }, 
      error = function(e) {
        cat("Error in dataset", j, "with lambda", lambda, ":", e$message, "\n")
        return(NULL)  # Return NULL if an error occurs
      })
    
    # Skip the rest of the loop if result is NULL
      if (is.null(result)) next
    
    #mse1 and bias1 for the current lambda
    results_list[[i]] <- list(
      dataset = j,  # Track which dataset this result is from
      lambda = lambda,
      mse1 = result$mse1,  
      bias1 = result$bias1,
      ave_lp = result$ave_lp_errors
    )
    n_iter_list[[(j - 1) * 10 + i]]=result$n_iter
    
    
    end_time = Sys.time()  
    simulation_time = as.numeric(difftime(end_time, start_time, units = "secs"))  
    simulation_times[[(j - 1) * 10 + i]] = simulation_time
    
    est_Gammamatrix_list[[(j - 1) * 10 + i]] = result$est_Gammamatrix_list
    est_Alphamatrix_list[[(j - 1) * 10 + i]] = result$est_Alphamatrix_list
    
  
        saveRDS(list(
      results_list = results_list,
      est_Gammamatrix_list = est_Gammamatrix_list,
      est_Alphamatrix_list = est_Alphamatrix_list,
      n_iter_list = n_iter_list,
      simulation_times = simulation_times
    ), file = file_name2)
      
      
  }
  
  # results list to a data frame 
  dataset_results_df <- do.call(rbind, lapply(results_list, as.data.frame))
  
  
  optimal_lambda <- dataset_results_df$lambda[which.min(dataset_results_df$ave_lp)]
  optimal_lambda_counts[as.character(optimal_lambda)] <- optimal_lambda_counts[as.character(optimal_lambda)] + 1
    
  results_df <- rbind(results_df, dataset_results_df) #contains mse, bias,ave_lp and lambda for all datasets
  print('DONEEE 1')
  
  
      saveRDS(list(
      results_df = results_df,
      optimal_lambda_counts = optimal_lambda_counts,
      est_Gammamatrix_list = est_Gammamatrix_list,
      est_Alphamatrix_list = est_Alphamatrix_list,
      n_iter_list = n_iter_list,
      simulation_times = simulation_times
    ), file = file_name1)
    
}

print("DONE with all datasets")
print(results_df)

best_lambda_by_count <- names(optimal_lambda_counts)[which.max(optimal_lambda_counts)]
count_of_best_lambda <- max(optimal_lambda_counts)
# To find the overall best lambda across all datasets


cat("Best lambda based on count across all datasets:", best_lambda_by_count, "\n")
  cat("Count of datasets where this lambda was optimal:", count_of_best_lambda, "\n\n")
  
  # Print all lambdas sorted by count of being optimal across all datasets
  cat("All lambdas sorted by count of being optimal across all datasets:\n")
  print(optimal_lambda_counts)
  
  return(list(
    results_df = results_df,
    optimal_lambda_counts = optimal_lambda_counts,
    best_lambda_by_count = best_lambda_by_count,
    count_of_best_lambda = count_of_best_lambda,
    est_Gammamatrix_list=est_Gammamatrix_list,
    est_Alphamatrix_list=est_Alphamatrix_list,
    n_iter_list=n_iter_list,
    simulation_times = simulation_times
  ))
}
```



# Function for Clculating Monte Carlo Error for MSE and Bias

```{r}
MC_errors_calc = function(mse_for_all_sims,bias_for_all_sims){
  
  MC_error_mse = sd(mse_for_all_sims)/sqrt(length(mse_for_all_sims))
  MC_error_bias = sd(bias_for_all_sims)/sqrt(length(bias_for_all_sims))
  
  return(list(
    MC_error_mse = MC_error_mse,
    MC_error_bias = MC_error_bias
  ))
}
```

# Function to generate plots

```{r}
  
generate_histograms <- function(performance_results_list, k) {
  bias3_df = performance_results_list$bias3_df
  mse3_df = performance_results_list$mse3_df
  bias1 = performance_results_list$bias1
  mse1 = performance_results_list$mse1
  cor_coeff_vec = performance_results_list$cor_coeff_vec


  
  # Helper function to create individual histograms
  create_histogram <- function(data, title, xlab, fill_color,binw,axis_text_size) {
    ggplot(data.frame(value = data), aes(x = value)) +
      geom_histogram(aes(y = ..density..), binwidth = binw, fill = fill_color, color = "black", alpha = 0.7) +
      geom_density(color = "blue", linetype = "dashed", linewidth = 1) +
      geom_vline(aes(xintercept = mean(data)), color = "red", linetype = "dotted", linewidth = 1) +
      labs(title = title, x = xlab, y = "Density") +
      theme_minimal()+
    theme(
      axis.text = element_text(size = axis_text_size),  # axis text
      axis.title = element_text(size = axis_text_size) # axis titles
    ) +
    scale_x_continuous(
      labels = number_format(accuracy = 10**(-2)) # decimals
    ) +
    scale_y_continuous(
      labels = number_format(accuracy = 10**(-2)) # decimals
    )
  }
  
  # Plot 1: Histogram of Mean Bias
  p1 <- create_histogram(bias1, "", "Mean Bias", "pink",0.001,8)
  
  # Plot 2: Histogram of Mean MSE
  p2 <- create_histogram(mse1, "", "Mean MSE", "orange",0.001,8)
  
  # Plot 3: Histograms of Mean Bias for each outcome
  bias_plots1 <- lapply(1:(k/2), function(i) {
    create_histogram(bias3_df[,i], paste("Outcome", i), "Mean Bias", "pink",0.005,4)
  })
  bias_plots2 <- lapply((k/2+1):k, function(i) {
    create_histogram(bias3_df[,i], paste("Outcome", i), "Mean Bias", "pink",0.005,4)
  })
  
  
  # Plot 4: Histograms of Mean MSE for each outcome
  mse_plots1 <- lapply(1:(k/2), function(i) {
    create_histogram(mse3_df[,i], paste("Outcome", i), "Mean MSE", "orange",0.001,4)
  })
  mse_plots2 <- lapply((k/2+1):k, function(i) {
    create_histogram(mse3_df[,i], paste("Outcome", i), "Mean MSE", "orange",0.001,4)
  })
    
  
  # Plot 5: Histogram of Correlation coefficient between B est and B true
  corr_plot <- create_histogram(cor_coeff_vec, "", "Corelation Coefficient between B true and B", "green",0.005,8)
  
  # Arrange plots in a grid 
  grid.arrange(corr_plot, ncol = 1, top = "Histogrm of Corelation Coefficient between B true and B estimate across 500 simulations")
  grid.arrange(p1, p2, ncol = 2, top = 'Histograms of Mean Bias(left) and Mean MSE(right) across 500 Simulations')
  
  grid.arrange(grobs = bias_plots1, ncol = 5, top = "Histograms of Mean Bias for each outcome across 500 Simulations(first part)")
  grid.arrange(grobs = bias_plots2, ncol = 5, top = "Histograms of Mean Bias for each outcome across 500 Simulations(second part)")
  
  grid.arrange(grobs = mse_plots1, ncol = 5, top = "Histograms of Mean MSE for each outcome across 500 Simulations(first part)")
  grid.arrange(grobs = mse_plots2, ncol = 5, top = "Histograms of Mean MSE for each outcome across 500 Simulations(second part)")
  
  return(list(
    meanbias1 = mean(bias1),
    meanmse1 = mean(mse1),
    meancorr =mean(cor_coeff_vec)
  ))
}
```


# Function to plot simulated data

```{r}
generate_data_plots <- function(dlong_list, n, r, p, k, case_type, corr, T_sim = NULL, T_obs = NULL) {
  library(data.table)
  library(ggplot2)
  library(gridExtra)
  library(grid)
  
  # Combine datasets into a single data.table
  combined_data <- if (is.data.table(dlong_list)) dlong_list else rbindlist(dlong_list)
  
  # Ensure numeric columns for predictors
  predictor_names <- grep("^x", names(combined_data), value = TRUE)
  
  # Compute density estimates for predictors
  density_data <- rbindlist(lapply(predictor_names, function(pred) {
    dens <- density(combined_data[[pred]], n = 512)
    data.table(variable = pred, x = dens$x, y = dens$y)
  }))
  
  # Compute mean and standard deviation of densities
  density_summary <- density_data[, .(
    mean_y = mean(y),
    sd_y = sd(y)
  ), by = .(x)]
  
  # Plot average density with standard deviation ribbon
  p1 <- ggplot(density_summary, aes(x = x, y = mean_y)) +
    geom_ribbon(aes(ymin = mean_y - sd_y, ymax = mean_y + sd_y), fill = "blue", alpha = 0.05) +
    geom_line(color = "blue") +
    labs(title = 'Average Density of \n Predictors with SD', x = 'Value', y = 'Density') +
    theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 15),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 15),                         
    legend.title = element_text(size = 15),                       
    plot.title = element_text(size = 20),           
    strip.text = element_text(size = 15)                           
  ) +
    theme(legend.position = "none")
  
  # Plot Tstop distribution if it exists
  if ("Tstop" %in% names(combined_data)) {
    p2 <- ggplot(combined_data, aes(x = Tstop)) +
      geom_density(fill = 'blue', alpha = 0.05) +
      labs(title = 'Distribution of Tstop', x = 'Tstop', y = 'Density') +
      theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 15),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 15),                         
    legend.title = element_text(size = 15),                       
    plot.title = element_text(size = 20),           
    strip.text = element_text(size = 15)                           
  )
  } else {
    p2 <- NULL
  }
  
  # Top title for the grid of plots
  top <- textGrob(
    paste('Datasets simulated using case ', case_type, ', \n correlation: ', corr, ', sample space: ', n),
    gp = gpar(fontsize = 25)
  )
  
  # Arrange plots
  grid_plots <- if (!is.null(p2)) {
    grid.arrange(p1, p2, ncol = 2, top = top)
  } else {
    grid.arrange(p1, top = top)
  }
  
  # Calculate and print status percentages if available
  if ("status" %in% names(combined_data)) {
    status_counts <- combined_data[, .N, by = status]
    status_percentages <- status_counts[, .(status, percentage = N / sum(N) * 100)]
    
    # Safeguard against missing statuses and print the results
    censored <- status_percentages[status == 0, percentage]
    uncensored <- status_percentages[status == 1, percentage]
    
    message(sprintf(
      "Percentage of Censored data: %.2f%%, Percentage of Uncensored data: %.2f%%",
      ifelse(length(censored) > 0, censored, 0),
      ifelse(length(uncensored) > 0, uncensored, 0)
    ))
  }
  
  return(grid_plots)
}


```


```{r}
# generate_data_plots <- function(dlong_list,n,r,p,k,T_sim=NULL,T_obs=NULL) {
# 
# combined_data=dlong_list
# T_sim_combined=T_sim
# T_obs_combined=T_obs
# # Combine all data sets into a single data frame
# if (!is.data.frame(dlong_list)){
# combined_data <- do.call(rbind, dlong_list)
# }
#   
# if (!is.null(T_sim)){
# T_sim_combined=do.call(rbind, T_sim)
# T_obs_combined=do.call(rbind, T_obs)
# }
# 
# predictor_names <- grep("^x", names(combined_data), value = TRUE)
# predictors_long <- reshape2::melt(combined_data, id.vars = 'id', measure.vars = predictor_names)
# 
# # Plot the distribution of predictors on the same plot
# p1 = ggplot(predictors_long, aes(x = value)) +
#   geom_density(alpha = 0.5, fill = "blue")+
#   # geom_density(alpha = 0.05) +
#   labs(title = 'Distribution of \n Predictors', x = 'Value', y = 'Density') +
#   # theme(legend.title = element_blank())+
#   theme(
#     axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
#     axis.text.y = element_text(size = 15),                         
#     axis.title.x = element_text(size = 15),                       
#     axis.title.y = element_text(size = 15),                          
#     plot.title = element_text(size = 20),           
#     strip.text = element_text(size = 15),
#     legend.position = "none"
#   )
# theme_minimal() 
# 
# # Plot the distribution of Tstop
# p2 = ggplot(combined_data, aes(x = Tstop)) +
#   geom_density(fill = 'blue', alpha = 0.05) +
#   labs(title = 'Distribution of Tstop', x = 'Tstop', y = 'Density') +
#   theme(legend.title = element_blank())+
#   theme(
#     axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
#     axis.text.y = element_text(size = 15),                         
#     axis.title.x = element_text(size = 15),                       
#     axis.title.y = element_text(size = 15),                       
#     legend.text = element_text(size = 15),                         
#     legend.title = element_text(size = 15),                       
#     plot.title = element_text(size = 20),           
#     strip.text = element_text(size = 15)                           
#   )
# theme_minimal() 
# 
# top = paste('Datasets with ',p,' covariates and ',k,' outcomes for ',n,' individuals')
# top <- textGrob(
#   paste('Datasets with ',p,' covariates, \n',k,' outcomes, ',n,' individuals'),
#   gp = gpar(fontsize = 25)  
# )
# grid_plots = grid.arrange(p1, p2, ncol = 2, top = top)
#  
# status_counts <- table(combined_data$status)
# status_percentages <- prop.table(status_counts) * 100
# # Print the percentages
# print(paste('Percentage of Censored data:', status_percentages[1],' Percentage of Uncensored data', status_percentages[2]))
# return(grid_plots)
# }
```



<!-- # Function to plot simulated data -->

<!-- ```{r} -->
<!-- generate_data_plots <- function(dlong_list,n,r,p,k,T_sim=NULL,T_obs=NULL) { -->

<!-- combined_data=dlong_list -->
<!-- T_sim_combined=T_sim -->
<!-- T_obs_combined=T_obs -->
<!-- # Combine all data sets into a single data frame -->
<!-- if (!is.data.frame(dlong_list)){ -->
<!-- combined_data <- do.call(rbind, dlong_list) -->
<!-- # print(summary(combined_data)) -->
<!-- } -->

<!-- if (!is.matrix(T_sim)){ -->
<!-- T_sim_combined=do.call(rbind, T_sim) -->
<!-- T_obs_combined=do.call(rbind, T_obs) -->
<!-- } -->

<!-- # predictor_names <- grep("^x", names(combined_data), value = TRUE) -->
<!-- # predictors_long <- reshape2::melt(combined_data, id.vars = 'id', measure.vars = predictor_names) -->

<!-- # Plot the distribution of predictors on the same plot -->
<!-- # p1 = ggplot(predictors_long, aes(x = value, color = variable, fill = variable)) + -->
<!-- #   geom_density(alpha = 0.05) + -->
<!-- #   labs(title = 'Distribution of Predictors', x = 'Value', y = 'Density') + -->
<!-- #   theme_minimal() + -->
<!-- #   theme(legend.title = element_blank()) -->

<!-- # Plot the distribution of Tstop -->
<!-- p2 = ggplot(combined_data, aes(x = Tstop)) + -->
<!--   geom_density(fill = 'blue', alpha = 0.05) + -->
<!--   labs(title = 'Distribution of Tstop', x = 'Tstop', y = 'Density') + -->
<!--   theme_minimal() -->

<!-- T_obs_long <- as.data.frame(T_obs_combined) %>% -->
<!--   pivot_longer( -->
<!--     cols = everything(),  -->
<!--     names_to = "variable",   -->
<!--     values_to = "value"      -->
<!--   ) -->

<!-- p3 = ggplot(T_obs_long, aes(x = value, color = variable)) + -->
<!--   geom_density() + -->
<!--   labs(title = 'T_obs Plot for Each Outcome', -->
<!--        x = 'T_obs', -->
<!--        y = 'Density') + -->
<!--   theme_minimal() -->

<!-- T_sim_long <- as.data.frame(T_sim_combined) %>% -->
<!--   pivot_longer( -->
<!--     cols = everything(),   -->
<!--     names_to = "variable",   -->
<!--     values_to = "value"      -->
<!--   ) -->

<!-- p4 = ggplot(T_sim_long, aes(x = value, color = variable)) + -->
<!--   geom_density() + -->
<!--   labs(title = 'T_sim Plot for Each Outcome', -->
<!--        x = 'T_simulated', -->
<!--        y = 'Density') + -->
<!--   theme_minimal() -->

<!-- top = paste('Datasets with ',p,' covariates and ',k,' outcomes for ',n,' individuals') -->
<!-- top <- textGrob( -->
<!--   paste('Datasets with ',p,' covariates and ',k,' outcomes for ',n,' individuals'), -->
<!--   gp = gpar(fontsize = 12)   -->
<!-- ) -->
<!-- grid_plots = grid.arrange(p2, p3, p4, ncol = 3, top = top) -->

<!-- status_counts <- table(combined_data$status) -->
<!-- status_percentages <- prop.table(status_counts) * 100 -->
<!-- # Print the percentages -->
<!-- print(paste('Percentage of Censored data:', status_percentages[1],' Percentage of Uncensored data', status_percentages[2])) -->
<!-- ggsave("dataplots1.png", plot = grid_plots, width = 23, height = 6, dpi = 300) -->
<!-- return(list(grid_plots)) -->
<!-- } -->
<!-- ``` -->

# Function to plot lambdas with LPE

```{r}
lambda_plot <- function(find_lambda,title=NULL) {
  
  results_df <- as.data.frame(find_lambda$results_df)
results_df$lambda <- as.factor(results_df$lambda)
min_mse_points <- results_df %>%
  group_by(dataset) %>%
  filter(ave_lp == min(ave_lp)) %>%
  ungroup()
lam_plot=ggplot(results_df, aes(x = lambda, y = ave_lp, color = as.factor(dataset), group = dataset)) +
  geom_line() +
  geom_point() +
  # Add red points for the lowest ave_lp in each dataset
  geom_point(data = min_mse_points, aes(x = lambda, y = ave_lp), color = "red", size = 3) +
  scale_x_discrete(labels = function(x) label_scientific(digits = 4)(as.numeric(x))) +  
  # scale_x_discrete(labels = function(x) sprintf("%.6f", as.numeric(x))) +  
  labs(
    title = title,
    x = expression(lambda),
    y = "LPE",
    color = "Dataset"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 15),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )



unique_lambdas <- unique(results_df$lambda)
#Find the lambda with minimum ave_lp for each dataset
optimal_lambdas <- results_df %>%
  group_by(dataset) %>%
  filter(ave_lp == min(ave_lp)) %>%
  ungroup() %>%
  select(lambda)
lambda_optimal_count <- optimal_lambdas %>%
  count(lambda)
lambda_count_vector <- setNames(rep(0, length(unique_lambdas)), unique_lambdas)
lambda_count_vector[names(lambda_count_vector) %in% lambda_optimal_count$lambda] <- lambda_optimal_count$n
values <- as.numeric(names(lambda_count_vector))
repeated_values <- rep(values, lambda_count_vector)
lambda_opt=median(repeated_values)

return(list(
    lambda_opt = lambda_opt,
    lam_plot = lam_plot
  ))
}
```


# Function to check if Beta Matrix is close to rank 1

```{r}
rank_check = function(Beta_m){
  
svd_result <- svd(Beta_m)

# Singular values
singular_values <- svd_result$d
sigma_1 <- singular_values[1]
sigma_2 <- singular_values[2]

# Check closeness to rank 1
ratio <- sigma_2 / sigma_1
difference <- sigma_1 - sigma_2


cat("Singular values:", singular_values, "\n")
cat("Ratio of singular values:", ratio, "\n")
cat("Difference between singular values:", difference, "\n")

# Determine if the matrix is close to rank 1
if (ratio < 0.01) {
  cat("The matrix is close to rank 1.\n")
} else {
  cat("The matrix is not close to rank 1.\n")
}
}
```

# Heatmaps

```{r}
beta_heatmap = function(title,Beta_true, performance_results,minb=NULL,maxb=NULL,minmax=FALSE) {

    bias_list = performance_results$bias_for_all_coeffs_and_simulations
    Beta_list_estimated = list()
    
    
    for(i in 1:length(performance_results$est_Alphamatrix_list)){
      
      if (is.null(performance_results$est_Alphamatrix_list[[i]])) {
        Beta_list_estimated[[i]]=NULL
    warning(paste("At iteration", i, "one of the matrices is NULL. Skipping this iteration."))
    next
      }
      
      
      Beta_list_estimated[[i]] = performance_results$est_Alphamatrix_list[[i]] %*% performance_results$est_Gammamatrix_list[[i]]
    }
    
   Beta_list_estimated <- Beta_list_estimated[!sapply(Beta_list_estimated, is.null)]
   sum_betas_estimated <- Reduce("+", Beta_list_estimated) #sum element wise all matrices in the list
  
  # Calculate the mean
  mean_beta <- sum_betas_estimated / length(Beta_list_estimated)
  
  colnames(mean_beta) <- paste("k=", 1:ncol(mean_beta), sep="")
  rownames(mean_beta) <- paste("X", 1:nrow(mean_beta), sep="")
  
  beta_df <- reshape2::melt(mean_beta)
  
  


if(minmax==TRUE){
breaks <- seq(minb, maxb, length.out = 101)
}
else{
 breaks <- seq(min(Beta_true), max(Beta_true), length.out = 101) 

}

norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# Generate the heatmap
# heatmap.2(mean_beta, Rowv=F, Colv=F, scale = "none", col = my_palette,
#           density.info = "none", trace = "none", dendrogram = "none",breaks=breaks)

p <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle(title)


print(min(mean_beta))
print(max(mean_beta))
return(p)
}



```


RATIO; rank1 first1000,  sec1000,     third1000,   first5000,    sec5000,     third5000: 
            6.046924e-16 1.19169e-16  3.614595e-16 6.046924e-16  1.19169e-16  3.614595e-16  

RATIO; rank2 first1000,   sec1000,   third1000,    first5000,    sec5000,     third5000: 
            0.09727308   0.7605145    0.1105586    0.09727308    0.7605145    0.1105586 

DIFF; rank1 first1000,  sec1000,   third1000, first5000, sec5000,    third5000: 
            0.1539391  0.05599193  0.1472581  0.1539391  0.05599193  0.1472581

DIFF; rank2 first1000, sec1000,    third1000,  first5000, sec5000,    third5000: 
            0.2474135  0.02385281  0.2159678  0.2474135  0.02385281  0.2159678 


# Sample:1000

# FIRST Configuration (sample size:1000, p=300,K=8,n_simulation=100-rangom case, but corelated with 0.7 corelation)

## Call functions to simulate n_simulation=100 datasets using rank r=1

```{r}
#set seed
set.seed(123)
#chose variables
n = 1000   # Number of observations
p <- 300  # Number of covariates
k <- 8  # Number of outcomes
n_simulations = 100

r <- 1  # Rank of simulated data

datas_s2_First1_1000 = simulations_data(n,p,r,k,n_simulations,case = 1,cor=0.7)
rank_check(datas_s2_First1_1000$Beta_matrix)

first1_beta_true=datas_s2_First1_1000$Beta_matrix

colnames(first1_beta_true) <- paste("k=", 1:ncol(first1_beta_true), sep="")
rownames(first1_beta_true) <- paste("X", 1:nrow(first1_beta_true), sep="")
beta_df <- reshape2::melt(first1_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(first1_beta_true), max(first1_beta_true), length.out = 101)
breaks <- seq( -0.00332, 0.0099, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_1_1 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 1")
```


### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_First1_1000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_First1_1000$T_sim,
#                     T_obs=datas_s2_First1_1000$T_obs)

first_1_1000 = generate_data_plots(datas_s2_First1_1000$dlong_list,n,r,p,k,1,0.7,T_sim=NULL,T_obs=NULL) 
```

### PENALISED FITTINGS

#### Fit 5 first datasets to find best lambda   #okok


```{r}
# #set seed
# set.seed(123)
# #
# R2 = 1 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_1000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_1000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_1000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(1.0e-2), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first11_1000 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR1,p,k,R2,'FIRST11')
# 
# lambda_plot(  find_lambda_s2_first11_1000)$lam_plot

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST11",".rds")
find_lambda_s2_first11_1000 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_first11_1000)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_first11_1000$results_df$lambda - lambda_plot(  find_lambda_s2_first11_1000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_first11_1000$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda   #okok



```{r}
# #set seed
# set.seed(123)
# #
# R2 = 1 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_1000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_1000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_1000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1.292e-3), log10(1.0e-2), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first11_1000_2 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR1,p,k,R2,'FIRST11_2')
# 
# lambda_plot(  find_lambda_s2_first11_1000_2)$lam_plot

```



```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST11_2",".rds")
find_lambda_s2_first11_1000_2 <- readRDS(file_name)

lambdas_first_11=lambda_plot(  find_lambda_s2_first11_1000_2,'Datasets simulated using rank 1, \n models fitted using rank 1')$lam_plot
```


```{r}

indexes=which(abs(find_lambda_s2_first11_1000_2$results_df$lambda - 0.005055384) < 1e-8)
mean(find_lambda_s2_first11_1000_2$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok



```{r}
# #set seed
# set.seed(123)
# #
# R2 = 1 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_1000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_1000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_1000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(2.556e-3), log10(1.0e-2), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first11_1000_3 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR1,p,k,R2,'FIRST11_3')
# 
# lambda_plot(  find_lambda_s2_first11_1000_3)$lam_plot

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST11_3",".rds")
find_lambda_s2_first11_1000_3 <- readRDS(file_name)

lambda_plot(  find_lambda_s2_first11_1000_3)$lam_plot
```


```{r}

indexes=which(abs(find_lambda_s2_first11_1000_3$results_df$lambda - lambda_plot(  find_lambda_s2_first11_1000_3)$lambda_opt) < 1e-8)
mean(find_lambda_s2_first11_1000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_first11_1000_2)$lambda_opt
# 
# performance_results_s2_first11_1000 = simulations_fit_and_preformance(datas_s2_First1_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'FIRST11')

```




```{r}
file_name <- paste0("simulation_progress_expFIRST11_0.005055384",".rds")
performance_results_s2_first11_1000 <- readRDS(file_name)

performance_results_s2_first11_1000$bias3_df <- do.call(rbind, performance_results_s2_first11_1000$bias3_list)
performance_results_s2_first11_1000$mse3_df <- do.call(rbind, performance_results_s2_first11_1000$mse3_list)

colnames(performance_results_s2_first11_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_first11_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_first11_1000$est_Gammamatrix_list, is.null))


```
##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first11_1000
title = "Fitted under rank 1"
Beta_true=first1_beta_true
  
beta_heat2_1_11=beta_heatmap(title,Beta_true, performance_results,-0.00332, 0.0099,minmax =TRUE ) 

```

##### Plot performance

```{r}
r_s2_first11_1000 = generate_histograms(performance_results_s2_first11_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_first11_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first11_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first11_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_first11_1000$lp_errors, as.vector))

MC_error_lp_first11_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# # set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_1000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_1000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_1000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(3.54e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first12_1000 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR2,p,k,R2,'FIRST12')
# 
# lambda_plot(find_lambda_s2_first12_1000)$lam_plot

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST12",".rds")
find_lambda_s2_first12_1000 <- readRDS(file_name)
lambda_plot(find_lambda_s2_first12_1000)$lam_plot
```


```{r}

indexes=which(abs(find_lambda_s2_first12_1000$results_df$lambda -  lambda_plot(find_lambda_s2_first12_1000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_first12_1000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_1000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_1000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_1000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(5.131e-4), log10(3.54e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first12_1000_2 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR2,p,k,R2,'FIRST12_2')
# 
# lambda_plot(find_lambda_s2_first12_1000_2)$lam_plot

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST12_2",".rds")
find_lambda_s2_first12_1000_2 <- readRDS(file_name)
lambda_plot(find_lambda_s2_first12_1000_2)$lam_plot
```


```{r}

indexes=which(abs(find_lambda_s2_first12_1000_2$results_df$lambda -  0.0018595285) < 1e-8)
mean(find_lambda_s2_first12_1000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_1000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_1000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_1000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1.86e-3), log10(3.54e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first12_1000_3 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR2,p,k,R2,'FIRST12_3')
# 
# lambda_plot(find_lambda_s2_first12_1000_3)$lam_plot

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST12_3",".rds")
find_lambda_s2_first12_1000_3 <- readRDS(file_name)
lambdas_first_12=lambda_plot(find_lambda_s2_first12_1000_3,'Datasets simulated using rank 1, \n models fitted using rank 2')$lam_plot
```


```{r}

indexes=which(abs(find_lambda_s2_first12_1000_3$results_df$lambda -  0.002856537) < 1e-8)
mean(find_lambda_s2_first12_1000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_first12_1000)$lambda_opt
# 
# performance_results_s2_first12_1000 = simulations_fit_and_preformance(datas_s2_First1_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'FIRST12')
```




```{r}
file_name <- paste0("simulation_progress_expFIRST12_0.002856537",".rds")
performance_results_s2_first12_1000 <- readRDS(file_name)

performance_results_s2_first12_1000$bias3_df <- do.call(rbind, performance_results_s2_first12_1000$bias3_list)
performance_results_s2_first12_1000$mse3_df <- do.call(rbind, performance_results_s2_first12_1000$mse3_list)

colnames(performance_results_s2_first12_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_first12_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_first12_1000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first12_1000
title = "Fitted under rank 2"
Beta_true=first1_beta_true
  
beta_heat2_1_12=beta_heatmap(title,Beta_true, performance_results,-0.00332, 0.0099,minmax =TRUE)

```

##### Plot performance

```{r}
r_s2_first12_1000 = generate_histograms(performance_results_s2_first12_1000, k)
```

##### ΜC ERRORS

```{r}

msesmc = unlist(lapply(performance_results_s2_first12_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first12_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first12_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}

lp_errors_mc = unlist(lapply(performance_results_s2_first12_1000$lp_errors, as.vector))

MC_error_lp_first12_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


## Call functions to simulate n_simulation=100 datasets using rank r=2

```{r}
#set seed
set.seed(123)

r <- 2  # Rank of simulated data

datas_s2_First2_1000 = simulations_data(n,p,r,k,n_simulations,case=1,corr = 0.7)

rank_check(datas_s2_First2_1000$Beta_matrix)

first2_beta_true=datas_s2_First2_1000$Beta_matrix


colnames(first2_beta_true) <- paste("k=", 1:ncol(first2_beta_true), sep="")
rownames(first2_beta_true) <- paste("X", 1:nrow(first2_beta_true), sep="")
beta_df <- reshape2::melt(first2_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(first2_beta_true), max(first2_beta_true), length.out = 101)
breaks <- seq(0.000101, 0.0172, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_1_2 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 2")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_First2_1000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_First2_1000$T_sim,
#                     T_obs=datas_s2_First2_1000$T_obs)
first_2_1000 =generate_data_plots(datas_s2_First2_1000$dlong_list,n,r,p,k,1,0.7,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS

#### Fit 5 first datasets to find best lambda #οkok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(1.37e-2), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first21_1000 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR1,p,k,R2,'FIRST21')
# 
# lambda_plot(find_lambda_s2_first21_1000 )$lam_plot

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST21",".rds")
find_lambda_s2_first21_1000 <- readRDS(file_name)
lambda_plot(find_lambda_s2_first21_1000 )$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_first21_1000$results_df$lambda - lambda_plot(find_lambda_s2_first21_1000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_first21_1000$results_df$ave_lp[indexes])

```

#### Fit 5 first datasets to find best lambda #οkok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.131e-4), log10(1.37e-2), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first21_1000_2 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR1,p,k,R2,'FIRST21_2')
# 
# lambda_plot(find_lambda_s2_first21_1000_2)$lam_plot

```



```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST21_2",".rds")
find_lambda_s2_first21_1000_2 <- readRDS(file_name)
lambda_plot(find_lambda_s2_first21_1000_2)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_first21_1000_2$results_df$lambda - lambda_plot(find_lambda_s2_first21_1000_2)$lambda_opt) < 1e-8)
mean(find_lambda_s2_first21_1000_2$results_df$ave_lp[indexes])

```

#### --Fit 5 first datasets to find best lambda #οkok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.591e-3), log10(1.37e-2), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first21_1000_3 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR1,p,k,R2,'FIRST21_3')
# 
# lambda_plot(find_lambda_s2_first21_1000_3)$lam_plot

```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST21_3",".rds")
find_lambda_s2_first21_1000_3 <- readRDS(file_name)

lambdas_first_21=lambda_plot(find_lambda_s2_first21_1000_3,'Datasets simulated using rank 2, \n models fitted using rank 1')$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_first21_1000_3$results_df$lambda - 0.003615081) < 1e-8)
mean(find_lambda_s2_first21_1000_3$results_df$ave_lp[indexes])

```

#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# 
# R2 = 1 #rank of fitted model
# 
# lambda_opt=lambda_plot(find_lambda_s2_first21_1000_2)$lambda_opt
# 
# performance_results_s2_first21_1000 = simulations_fit_and_preformance(datas_s2_First2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'FIRST21')
```



```{r}
file_name <- paste0("simulation_progress_expFIRST21_0.003615081",".rds")
performance_results_s2_first21_1000 <- readRDS(file_name)

performance_results_s2_first21_1000$bias3_df <- do.call(rbind, performance_results_s2_first21_1000$bias3_list)
performance_results_s2_first21_1000$mse3_df <- do.call(rbind, performance_results_s2_first21_1000$mse3_list)

colnames(performance_results_s2_first21_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_first21_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_first21_1000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first21_1000
title = "Fitted under rank 1"
Beta_true=first2_beta_true
  
beta_heat2_1_21=beta_heatmap(title,Beta_true, performance_results,0.000101, 0.0172,minmax = TRUE) 

```


##### Plot performance

```{r}
r_s2_first21_1000 = generate_histograms(performance_results_s2_first21_1000, k)
```




##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_first21_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first21_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first21_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}

lp_errors_mc = unlist(lapply(performance_results_s2_first21_1000$lp_errors, as.vector))

MC_error_lp_first21_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(2.46e-2), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first22_1000 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR2,p,k,R2,'FIRST22')
# 
# lambda_plot(find_lambda_s2_first22_1000 )$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST22",".rds")
find_lambda_s2_first22_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first22_1000 )$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_first22_1000$results_df$lambda - lambda_plot(find_lambda_s2_first22_1000 )$lambda_opt) < 1e-8)
mean(find_lambda_s2_first22_1000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(3.36e-4), log10(2.46e-2), n = 6)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first22_1000_2 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR2,p,k,R2,'FIRST22_2')
# 
# lambda_plot(find_lambda_s2_first22_1000_2 )$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST22_2",".rds")
find_lambda_s2_first22_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first22_1000_2 )$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_first22_1000_2$results_df$lambda - lambda_plot(find_lambda_s2_first22_1000_2 )$lambda_opt) < 1e-8)
mean(find_lambda_s2_first22_1000_2$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.871e-3), log10(1.042e-2), n = 6)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first22_1000_3 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR2,p,k,R2,'FIRST22_3')
# 
# lambda_plot(find_lambda_s2_first22_1000_3 )$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetFIRST22_3",".rds")
find_lambda_s2_first22_1000_3 <- readRDS(file_name)


lambdas_first_22=lambda_plot(find_lambda_s2_first22_1000_3,'Datasets simulated using rank 2, \n models fitted using rank 2')$lam_plot

```

```{r}
indexes=which(abs(find_lambda_s2_first22_1000_3$results_df$lambda - 0.007391098) < 1e-8)
mean(find_lambda_s2_first22_1000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_first22_1000)$lambda_opt
# 
# performance_results_s2_first22_1000 = simulations_fit_and_preformance(datas_s2_First2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'FIRST22')
```



```{r}
file_name <- paste0("simulation_progress_expFIRST22_0.007391098",".rds")
performance_results_s2_first22_1000 <- readRDS(file_name)

performance_results_s2_first22_1000$bias3_df <- do.call(rbind, performance_results_s2_first22_1000$bias3_list)
performance_results_s2_first22_1000$mse3_df <- do.call(rbind, performance_results_s2_first22_1000$mse3_list)

colnames(performance_results_s2_first22_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_first22_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_first22_1000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first22_1000
title = "Fitted under rank 2"
Beta_true=first2_beta_true
  
beta_heat2_1_22=beta_heatmap(title,Beta_true, performance_results,0.000101, 0.0172,minmax = TRUE)

```


##### Plot performance

```{r}
r_s2_first22_1000 = generate_histograms(performance_results_s2_first22_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_first22_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first22_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first22_1000 = MC_errors_calc(msesmc,biasmc)
```



##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_first22_1000$lp_errors, as.vector))

MC_error_lp_first22_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```



#### Fit 5 first datasets to find best lambda #οkok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(2.80e-2), n = 10)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first23_1000 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR3,p,k,R2,'FIRST23')
# lambda_plot(find_lambda_s2_first23_1000)$lam_plot
```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldatasetFIRST23",".rds")
# find_lambda_s2_first23_1000 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_first23_1000)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_first23_1000$results_df$lambda - lambda_plot(find_lambda_s2_first23_1000)$lambda_opt) < 1e-8)
# mean(find_lambda_s2_first23_1000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda #οkok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(3.715e-4), log10(2.80e-2), n = 6)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first23_1000_2 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR3,p,k,R2,'FIRST23_2')
# lambda_plot(find_lambda_s2_first23_1000_2)$lam_plot

```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldatasetFIRST23_2",".rds")
# find_lambda_s2_first23_1000_2 <- readRDS(file_name)
# lambda_plot(find_lambda_s2_first23_1000_2)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_first23_1000_2$results_df$lambda - 0.004969107) < 1e-8)
# mean(find_lambda_s2_first23_1000_2$results_df$ave_lp[indexes])
```



#### --Fit 5 first datasets to find best lambda #οkok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_1000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_1000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_1000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.093e-3), log10(1.180e-2), n = 6)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first23_1000_3 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR3,p,k,R2,'FIRST23_3')
# lambda_plot(find_lambda_s2_first23_1000_3)$lam_plot

```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldatasetFIRST23_3",".rds")
# find_lambda_s2_first23_1000_3 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_first23_1000_3)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_first23_1000_3$results_df$lambda - 0.004180366) < 1e-8)
# mean(find_lambda_s2_first23_1000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=3

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# 
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_first23_1000)$lambda_opt
# 
# performance_results_s2_first23_1000 = simulations_fit_and_preformance(datas_s2_First2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR3, Print_flug, 'FIRST23')
```


```{r}
# file_name <- paste0("simulation_progress_expFIRST23_0.004969107_",".rds")
# performance_results_s2_first23_1000 <- readRDS(file_name)
# 
# performance_results_s2_first23_1000$bias3_df <- do.call(rbind, performance_results_s2_first23_1000$bias3_list)
# performance_results_s2_first23_1000$mse3_df <- do.call(rbind, performance_results_s2_first23_1000$mse3_list)
# 
# colnames(performance_results_s2_first23_1000$bias3_df) <- paste0("Outcome_", 1:k)
# colnames(performance_results_s2_first23_1000$mse3_df) <- paste0("Outcome_", 1:k)
# 
# sum(sapply(performance_results_s2_first23_1000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
# performance_results=performance_results_s2_first23_1000
# title = "Fitted under rank 3"
# Beta_true=first2_beta_true
#   
# beta_heat2_1_23=beta_heatmap(title,Beta_true, performance_results)

```

##### Plot performance

```{r}
# r_s2_first23_1000 = generate_histograms(performance_results_s2_first23_1000, k)
```

##### ΜC ERRORS

```{r}
# msesmc = unlist(lapply(performance_results_s2_first23_1000$mse_for_all_coeffs, as.vector))
# biasmc = unlist(lapply(performance_results_s2_first23_1000$bias_for_all_coeffs, as.vector))
# MC_errors_s2_first23_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
# lp_errors_mc = unlist(lapply(performance_results_s2_first23_1000$lp_errors, as.vector))
# 
# MC_error_lp_first23_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

### Heatmaps

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=heatmapreal2_1_1
plot_listf1[[2]]=beta_heat2_1_11
plot_listf1[[3]]=beta_heat2_1_12
# plot_listf1[[4]]=NULL
plot_listf1[[4]]=heatmapreal2_1_2
plot_listf1[[5]]=beta_heat2_1_21
plot_listf1[[6]]=beta_heat2_1_22
# plot_listf1[[8]]=NULL

top=''

heatmaps_1 <- grid.arrange(grobs = plot_listf1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("heatmaps2_1000_1.png", plot = heatmaps_1, width = 23, height = 6, dpi = 300)
```

### Lambda plots

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=lambdas_first_11
plot_listf1[[2]]=lambdas_first_12
plot_listf1[[3]]=lambdas_first_21
plot_listf1[[4]]=lambdas_first_22

top=''

lambdas_1_1000 <- grid.arrange(grobs = plot_listf1, ncol = 2, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("lambdas_1_1000.png", plot = lambdas_1_1000, width = 17, height = 7, dpi = 300)
```

# SECOND Configuration (sample size:1000, p=300,K=8,n_simulation=100-case with half predictors for each outcome zeros and cor=0.7)

Fit only three unpenalized data to show that needs much time

## Call functions to simulate n_simulation=100 datasets using rank r=1 with half predictors be zeros

```{r}
#set seed
set.seed(123)
#chose variables
n = 1000   # Number of observations
p <- 300  # Number of covariates
k <- 8  # Number of outcomes
n_simulations = 100

r <- 1  # Rank of simulated data

datas_s2_second1_1000 = simulations_data(n,p,r,k,n_simulations,case = 2,corr = 0.7)

rank_check(datas_s2_second1_1000$Beta_matrix)

second1_beta_true=datas_s2_second1_1000$Beta_matrix

colnames(second1_beta_true) <- paste("k=", 1:ncol(second1_beta_true), sep="")
rownames(second1_beta_true) <- paste("X", 1:nrow(second1_beta_true), sep="")
beta_df <- reshape2::melt(second1_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(second1_beta_true), max(second1_beta_true), length.out = 101)
breaks <- seq(-0.012 ,0.0158, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_2_1 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 1")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_second1_1000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_second1_1000$T_sim,
#                     T_obs=datas_s2_second1_1000$T_obs)

second_1_1000=generate_data_plots(datas_s2_second1_1000$dlong_list,n,r,p,k,2,0.7,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (no unpenalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(3.64e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second11_1000 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR1,p,k,R2,'SECOND11')
# 
# lambda_plot(find_lambda_s2_second11_1000)
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND11",".rds")
find_lambda_s2_second11_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second11_1000)
```

```{r}
indexes=which(abs(find_lambda_s2_second11_1000$results_df$lambda - lambda_plot(find_lambda_s2_second11_1000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_second11_1000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.098e-5), log10(3.64e-3), n = 8)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second11_1000_2 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR1,p,k,R2,'SECOND11_2')
# 
# lambda_plot(find_lambda_s2_second11_1000_2)
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND11_2",".rds")
find_lambda_s2_second11_1000_2 <- readRDS(file_name)
lambda_plot(find_lambda_s2_second11_1000_2)
```

```{r}
indexes=which(abs(find_lambda_s2_second11_1000_2$results_df$lambda - 1.588657e-03) < 1e-8)
mean(find_lambda_s2_second11_1000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.589e-3), log10(3.64e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second11_1000_3 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR1,p,k,R2,'SECOND11_3')
# 
# lambda_plot(find_lambda_s2_second11_1000_3)
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND11_3",".rds")
find_lambda_s2_second11_1000_3 <- readRDS(file_name)

lambdas_second_11=lambda_plot(find_lambda_s2_second11_1000_3,'Datasets simulated using rank 1, \n models fitted using rank 1')$lam_plot

```

```{r}
indexes=which(abs(find_lambda_s2_second11_1000_3$results_df$lambda - 0.002761270 ) < 1e-8)
mean(find_lambda_s2_second11_1000_3$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
#set seed
set.seed(123)

R2 = 1 #rank of fitted model
datasets_list_y <- list()
datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]


lambda_vector = logspace(log10(2.761e-3), log10(3.64e-3), n = 4)
Gamma.startR1<- matrix(rnorm(R2*k),R2,k)

find_lambda_s2_second11_1000_4 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR1,p,k,R2,'SECOND11_4')

lambda_plot(find_lambda_s2_second11_1000_4)
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND11_4",".rds")
find_lambda_s2_second11_1000_4 <- readRDS(file_name)
lambda_plot(find_lambda_s2_second11_1000_4)
```

```{r}
indexes=which(abs(find_lambda_s2_second11_1000_4$results_df$lambda - 2.761e-3 ) < 1e-8)
mean(find_lambda_s2_second11_1000_4$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# lambda_opt=lambda_plot(find_lambda_s2_second11_1000)$lambda_opt
#   
# performance_results_s2_second11_1000 = simulations_fit_and_preformance(datas_s2_second1_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'SECOND11')
```



```{r}
file_name <- paste0("simulation_progress_expSECOND11_0.002761270_",".rds")
performance_results_s2_second11_1000 <- readRDS(file_name)

performance_results_s2_second11_1000$bias3_df <- do.call(rbind, performance_results_s2_second11_1000$bias3_list)
performance_results_s2_second11_1000$mse3_df <- do.call(rbind, performance_results_s2_second11_1000$mse3_list)

colnames(performance_results_s2_second11_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second11_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second11_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second11_1000
title = "Fitted under rank 1"
Beta_true=second1_beta_true
  
beta_heat2_2_11=beta_heatmap(title,Beta_true, performance_results,-0.012 ,0.0158 ,minmax = TRUE)

```


##### Plot performance

```{r}
r_s2_second11_1000 = generate_histograms(performance_results_s2_second11_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_second11_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second11_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second11_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second11_1000$lp_errors, as.vector))

MC_error_lp_second11_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(2.62e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second12_1000 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR2,p,k,R2,'SECOND12')
# 
# 
# lambda_plot(find_lambda_s2_second12_1000)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND12",".rds")
find_lambda_s2_second12_1000 <- readRDS(file_name)
lambda_plot(find_lambda_s2_second12_1000)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_second12_1000$results_df$lambda - 3.926862e-04 ) < 1e-8)
mean(find_lambda_s2_second12_1000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(5.886e-5), log10(2.62e-3), n = 6)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second12_1000_2 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR2,p,k,R2,'SECOND12_2')
# 
# 
# lambda_plot(find_lambda_s2_second12_1000_2)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND12_2",".rds")
find_lambda_s2_second12_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second12_1000_2)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second12_1000_2$results_df$lambda - 0.0012263236  ) < 1e-8)
mean(find_lambda_s2_second12_1000_2$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.226e-3), log10(2.62e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second12_1000_3 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR2,p,k,R2,'SECOND12_3')
# 
# 
# lambda_plot(find_lambda_s2_second12_1000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND12_3",".rds")
find_lambda_s2_second12_1000_3 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second12_1000_3)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_second12_1000_3$results_df$lambda - 0.002034063 ) < 1e-8)
mean(find_lambda_s2_second12_1000_3$results_df$ave_lp[indexes])
```
#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_1000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_1000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_1000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.034e-3), log10(2.62e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second12_1000_4 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR2,p,k,R2,'SECOND12_4')
# 
# 
# lambda_plot(find_lambda_s2_second12_1000_4)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND12_4",".rds")
find_lambda_s2_second12_1000_4 <- readRDS(file_name)

lambdas_second_12=lambda_plot(find_lambda_s2_second12_1000_4,'Datasets simulated using rank 1, \n models fitted using rank 2')$lam_plot

```


```{r}
indexes=which(abs(find_lambda_s2_second12_1000_4$results_df$lambda - 0.002407971  ) < 1e-8)
mean(find_lambda_s2_second12_1000_4$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second12_1000)$lambda_opt
# 
# performance_results_s2_second12_1000 = simulations_fit_and_preformance(datas_s2_second1_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'SECOND12')

```




```{r}
file_name <- paste0("simulation_progress_expSECOND12_0.002407971_",".rds")
performance_results_s2_second12_1000 <- readRDS(file_name)

performance_results_s2_second12_1000$bias3_df <- do.call(rbind, performance_results_s2_second12_1000$bias3_list)
performance_results_s2_second12_1000$mse3_df <- do.call(rbind, performance_results_s2_second12_1000$mse3_list)

colnames(performance_results_s2_second12_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second12_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second12_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second12_1000
title = "Fitted under rank 2"
Beta_true=second1_beta_true
  
beta_heat2_2_12=beta_heatmap(title,Beta_true, performance_results,-0.012 ,0.0158 ,minmax = TRUE)

```


##### Plot performance

```{r}
r_s2_second12_1000 = generate_histograms(performance_results_s2_second12_1000, k)
```

##### ΜC ERRORS

```{r}

msesmc = unlist(lapply(performance_results_s2_second12_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second12_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second12_1000 = MC_errors_calc(msesmc,biasmc)
```



##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second12_1000$lp_errors, as.vector))

MC_error_lp_second12_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

## Call functions to simulate n_simulation=100 datasets using rank r=2 with half predictors be zeros

```{r}
#set seed
set.seed(123)

r <- 2  # Rank of simulated data

datas_s2_second2_1000 = simulations_data(n,p,r,k,n_simulations,case=2,corr = 0.7)

rank_check(datas_s2_second2_1000$Beta_matrix)

second2_beta_true=datas_s2_second2_1000$Beta_matrix

colnames(second2_beta_true) <- paste("k=", 1:ncol(second2_beta_true), sep="")
rownames(second2_beta_true) <- paste("X", 1:nrow(second2_beta_true), sep="")
beta_df <- reshape2::melt(second2_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(second2_beta_true), max(second2_beta_true), length.out = 101)
breaks <- seq(-0.00166, 0.00975, length.out = 101)
 
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_2_2 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 2")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_second2_1000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_second2_1000$T_sim,
#                     T_obs=datas_s2_second2_1000$T_obs)

second_2_1000=generate_data_plots(datas_s2_second2_1000$dlong_list,n,r,p,k,2,0.7,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (not penalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(2.86e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second21_1000 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR1,p,k,R2,'SECOND21')
# 
# lambda_plot(find_lambda_s2_second21_1000)$lam_plot
```




```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND21",".rds")
find_lambda_s2_second21_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second21_1000)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second21_1000$results_df$lambda - 0.00286 ) < 1e-8)
mean(find_lambda_s2_second21_1000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(4.245e-4), log10(2.86e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second21_1000_2 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR1,p,k,R2,'SECOND21_2')
# 
# lambda_plot(find_lambda_s2_second21_1000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND21_2",".rds")
find_lambda_s2_second21_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second21_1000_2)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second21_1000_2$results_df$lambda - 0.00286 ) < 1e-8)
mean(find_lambda_s2_second21_1000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1.514e-3), log10(2.86e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second21_1000_3 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR1,p,k,R2,'SECOND21_3')
# 
# lambda_plot(find_lambda_s2_second21_1000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND21_3",".rds")
find_lambda_s2_second21_1000_3 <- readRDS(file_name)



lambdas_second_21=lambda_plot(find_lambda_s2_second21_1000_3,'Datasets simulated using rank 2, \n models fitted using rank 1')$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second21_1000_3$results_df$lambda - 0.00286 ) < 1e-8)
mean(find_lambda_s2_second21_1000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second21_1000)$lambda_opt
# 
# performance_results_s2_second21_1000 = simulations_fit_and_preformance(datas_s2_second2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'SECOND21')
```



```{r}
file_name <- paste0("simulation_progress_expSECOND21_0.00286_",".rds")
performance_results_s2_second21_1000 <- readRDS(file_name)

performance_results_s2_second21_1000$bias3_df <- do.call(rbind, performance_results_s2_second21_1000$bias3_list)
performance_results_s2_second21_1000$mse3_df <- do.call(rbind, performance_results_s2_second21_1000$mse3_list)

colnames(performance_results_s2_second21_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second21_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second21_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second21_1000
title = "Fitted under rank 1"
Beta_true=second2_beta_true
  
beta_heat2_2_21=beta_heatmap(title,Beta_true, performance_results,-0.00166, 0.00975,minmax=TRUE)

```

##### Plot performance

```{r}
r_s2_second21_1000 = generate_histograms(performance_results_s2_second21_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_second21_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second21_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second21_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second21_1000$lp_errors, as.vector))

MC_error_lp_second21_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(5.43e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second22_1000 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR2,p,k,R2,'SECOND22')
# 
# 
# lambda_plot(find_lambda_s2_second22_1000)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND22",".rds")
find_lambda_s2_second22_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second22_1000)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_second22_1000$results_df$lambda - 7.505465e-04 ) < 1e-8)
mean(find_lambda_s2_second22_1000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(7.505e-4), log10(5.43e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second22_1000_2 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR2,p,k,R2,'SECOND22_2')
# 
# 
# lambda_plot(find_lambda_s2_second22_1000_2)$lam_plot
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND22_2",".rds")
find_lambda_s2_second22_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second22_1000_2)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_second22_1000_2$results_df$lambda - 5.43e-3 ) < 1e-8)
mean(find_lambda_s2_second22_1000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.807e-3), log10(5.43e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second22_1000_3 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR2,p,k,R2,'SECOND22_3')
# 
# 
# lambda_plot(find_lambda_s2_second22_1000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND22_3",".rds")
find_lambda_s2_second22_1000_3 <- readRDS(file_name)


lambdas_second_22=lambda_plot(find_lambda_s2_second22_1000_3,'Datasets simulated using rank 2, \n models fitted using rank 2')$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second22_1000_3$results_df$lambda - 0.004357934  ) < 1e-8)
mean(find_lambda_s2_second22_1000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second22_1000)$lambda_opt
#   
# performance_results_s2_second22_1000 = simulations_fit_and_preformance(datas_s2_second2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'SECOND22')
```




```{r}
file_name <- paste0("simulation_progress_expSECOND22_0.004357934_",".rds")
performance_results_s2_second22_1000 <- readRDS(file_name)

performance_results_s2_second22_1000$bias3_df <- do.call(rbind, performance_results_s2_second22_1000$bias3_list)
performance_results_s2_second22_1000$mse3_df <- do.call(rbind, performance_results_s2_second22_1000$mse3_list)

colnames(performance_results_s2_second22_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second22_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second22_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second22_1000
title = "Fitted under rank 2"
Beta_true=second2_beta_true
  
beta_heat2_2_22=beta_heatmap(title,Beta_true, performance_results,-0.00166, 0.00975,minmax=TRUE) 

```
##### Plot performance

```{r}
r_s2_second22_1000 = generate_histograms(performance_results_s2_second22_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_second22_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second22_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second22_1000 = MC_errors_calc(msesmc,biasmc)
```



##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second22_1000$lp_errors, as.vector))

MC_error_lp_second22_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```



#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(5.42e-3), n = 10)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second23_1000 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR3,p,k,R2,'SECOND23')
# 
# lambda_plot(find_lambda_s2_second23_1000)$lam_plot

```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND23",".rds")
find_lambda_s2_second23_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second23_1000)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second23_1000$results_df$lambda - lambda_plot(find_lambda_s2_second23_1000)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_second23_1000$results_df$ave_lp[indexes])
```
#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(7.493e-4), log10(5.42e-3), n = 4)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second23_1000_2 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR3,p,k,R2,'SECOND23_2')
# 
# lambda_plot(find_lambda_s2_second23_1000_2)$lam_plot

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND23_2",".rds")
find_lambda_s2_second23_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second23_1000_2)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_second23_1000_2$results_df$lambda - lambda_plot(find_lambda_s2_second23_1000_2)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_second23_1000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_1000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_1000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_1000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.803e-3), log10(5.42e-3), n = 4)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second23_1000_3 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR3,p,k,R2,'SECOND23_3')
# 
# lambda_plot(find_lambda_s2_second23_1000_3)$lam_plot

```



```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetSECOND23_3",".rds")
find_lambda_s2_second23_1000_3 <- readRDS(file_name)

lambdas_second_23=lambda_plot(find_lambda_s2_second23_1000_3,'Datasets simulated using rank 2, \n models fitted using rank 3')$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second23_1000_3$results_df$lambda - 0.004350514   ) < 1e-8)
mean(find_lambda_s2_second23_1000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=3

##### Get performance



```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# 
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second23_1000)$lambda_opt
# 
# performance_results_s2_second23_1000 = simulations_fit_and_preformance(datas_s2_second2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR3, Print_flug,'SECOND23')
```

```{r}
file_name <- paste0("simulation_progress_expSECOND23_0.004350514_",".rds")
performance_results_s2_second23_1000 <- readRDS(file_name)

performance_results_s2_second23_1000$bias3_df <- do.call(rbind, performance_results_s2_second23_1000$bias3_list)
performance_results_s2_second23_1000$mse3_df <- do.call(rbind, performance_results_s2_second23_1000$mse3_list)

colnames(performance_results_s2_second23_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second23_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second23_1000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second23_1000
title = "Fitted under rank 3"
Beta_true=second2_beta_true
  
beta_heat2_2_23=beta_heatmap(title,Beta_true, performance_results,-0.00166, 0.00975,minmax=TRUE)

```

##### Plot performance

```{r}
r_s2_second23_1000 = generate_histograms(performance_results_s2_second23_1000, k)
```

##### ΜC ERRORS

```{r}

msesmc = unlist(lapply(performance_results_s2_second23_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second23_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second23_1000 = MC_errors_calc(msesmc,biasmc)
```




##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second23_1000$lp_errors, as.vector))

MC_error_lp_second23_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


### Heatmaps

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=heatmapreal2_2_1
plot_listf1[[2]]=beta_heat2_2_11
plot_listf1[[3]]=beta_heat2_2_12
plot_listf1[[4]]=NULL
plot_listf1[[5]]=heatmapreal2_2_2
plot_listf1[[6]]=beta_heat2_2_21
plot_listf1[[7]]=beta_heat2_2_22
plot_listf1[[8]]=beta_heat2_2_23

top=''

heatmaps_2 <- grid.arrange(grobs = plot_listf1, ncol = 4, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("heatmaps2_1000_2.png", plot = heatmaps_2, width = 23, height = 6, dpi = 300)
```
### Lambda plots

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=lambdas_second_11
plot_listf1[[2]]=lambdas_second_12
plot_listf1[[3]]=lambdas_second_21
plot_listf1[[4]]=lambdas_second_22
plot_listf1[[5]]=lambdas_second_23
top=''

lambdas_2_1000 <- grid.arrange(grobs = plot_listf1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("lambdas_2_1000.png", plot = lambdas_2_1000,width = 20, height = 8, dpi = 300)
```

# THIRD Configuration (sample size:1000, p=300,K=8,n_simulation=100-randomly zeros in A and G and cor=0.1)

Fit only three unpenalized data to show that needs much time

## Call functions to simulate n_simulation=100 datasets using rank r=1 with random zeros

```{r}
#set seed
set.seed(123)
#chose variables
n = 1000   # Number of observations
p <- 300  # Number of covariates
k <- 8  # Number of outcomes
n_simulations = 100

r <- 1  # Rank of simulated data

datas_s2_third1_1000 = simulations_data(n,p,r,k,n_simulations,case =3,corr = 0.1)

rank_check(datas_s2_third1_1000$Beta_matrix)

third1_beta_true=datas_s2_third1_1000$Beta_matrix

colnames(third1_beta_true) <- paste("k=", 1:ncol(third1_beta_true), sep="")
rownames(third1_beta_true) <- paste("X", 1:nrow(third1_beta_true), sep="")
beta_df <- reshape2::melt(third1_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(third1_beta_true), max(third1_beta_true), length.out = 101)
breaks <- seq(-0.0113,0.00948, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_3_1 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 1")

```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_third1_1000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_third1_1000$T_sim,
#                     T_obs=datas_s2_third1_1000$T_obs)

third_1_1000=generate_data_plots(datas_s2_third1_1000$dlong_list,n,r,p,k,3,0.1,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (no unpenalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(4.33e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third11_1000 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD11')
# lambda_plot(find_lambda_s2_third11_1000)$lam_plot
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD11",".rds")
find_lambda_s2_third11_1000 <- readRDS(file_name)

lambdas_third_11_1=lambda_plot(find_lambda_s2_third11_1000)$lam_plot
lambdas_third_11_1
```


```{r}
indexes=which(abs(find_lambda_s2_third11_1000$results_df$lambda - 6.137468e-04) < 1e-8)
mean(find_lambda_s2_third11_1000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.23e-5), log10(4.33e-3), n = 8)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third11_1000_2 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD11_2')
# lambda_plot(find_lambda_s2_third11_1000_2)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD11_2",".rds")
find_lambda_s2_third11_1000_2 <- readRDS(file_name)

lambdas_third_11_2=lambda_plot(find_lambda_s2_third11_1000_2)$lam_plot
lambdas_third_11_2
```


```{r}
indexes=which(abs(find_lambda_s2_third11_1000_2$results_df$lambda - 1.873658e-03) < 1e-8)
mean(find_lambda_s2_third11_1000_2$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.87e-3), log10(4.33e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third11_1000_3 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD11_3')
# lambda_plot(find_lambda_s2_third11_1000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD11_3",".rds")
find_lambda_s2_third11_1000_3 <- readRDS(file_name)

lambdas_third_11_3=lambda_plot(find_lambda_s2_third11_1000_3)$lam_plot
lambdas_third_11_3
```



```{r}
indexes=which(abs(find_lambda_s2_third11_1000_3$results_df$lambda -  0.003272948  ) < 1e-8)
mean(find_lambda_s2_third11_1000_3$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(3.273e-3), log10(4.33e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third11_1000_4 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD11_4')
# lambda_plot(find_lambda_s2_third11_1000_4)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD11_4",".rds")
find_lambda_s2_third11_1000_4 <- readRDS(file_name)

lambdas_third_11_4=lambda_plot(find_lambda_s2_third11_1000_4)$lam_plot
lambdas_third_11=lambda_plot(find_lambda_s2_third11_1000_4,'Datasets simulated using rank 1, \n models fitted using rank 1')$lam_plot
lambdas_third_11
```



```{r}
indexes=which(abs(find_lambda_s2_third11_1000_4$results_df$lambda -  0.003944336  ) < 1e-8)
mean(find_lambda_s2_third11_1000_4$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_third11_1000)$lambda_opt
#   
# performance_results_s2_third11_1000 = simulations_fit_and_preformance(datas_s2_third1_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'THIRD11')
```




```{r}
file_name <- paste0("simulation_progress_expTHIRD11_0.003593023 _",".rds")
performance_results_s2_third11_1000 <- readRDS(file_name)

performance_results_s2_third11_1000$bias3_df <- do.call(rbind, performance_results_s2_third11_1000$bias3_list)
performance_results_s2_third11_1000$mse3_df <- do.call(rbind, performance_results_s2_third11_1000$mse3_list)

colnames(performance_results_s2_third11_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third11_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third11_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third11_1000
title = "Fitted under rank 1"
Beta_true=third1_beta_true
  
beta_heat2_3_11=beta_heatmap(title,Beta_true, performance_results,-0.0113,0.00948,minmax = TRUE)

```


##### Plot performance

```{r}
r_s2_third11_1000 = generate_histograms(performance_results_s2_third11_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_third11_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third11_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third11_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third11_1000$lp_errors, as.vector))

MC_error_lp_third11_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(3.41e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third12_1000 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD12')
# lambda_plot(find_lambda_s2_third12_1000)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD12",".rds")
find_lambda_s2_third12_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third12_1000)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_third12_1000$results_df$lambda -  4.963427e-04 ) < 1e-8)
mean(find_lambda_s2_third12_1000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(4.963e-10), log10(3.41e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third12_1000_2 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD12_2')
# lambda_plot(find_lambda_s2_third12_1000_2)$lam_plot
```




```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD12_2",".rds")
find_lambda_s2_third12_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third12_1000_2)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_third12_1000_2$results_df$lambda -  1.793705e-05 ) < 1e-8)
mean(find_lambda_s2_third12_1000_2$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1.794e-5), log10(3.41e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third12_1000_3 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD12_3')
# lambda_plot(find_lambda_s2_third12_1000_3)$lam_plot
```




```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD12_3",".rds")
find_lambda_s2_third12_1000_3 <- readRDS(file_name)
lambda_plot(find_lambda_s2_third12_1000_3)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third12_1000_3$results_df$lambda -  0.0005930761  ) < 1e-8)
mean(find_lambda_s2_third12_1000_3$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_1000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_1000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_1000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_1000$X_list[1:5]
# 
# lambda_vector = logspace(log10(5.931e-4), log10(3.41e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third12_1000_4 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD12_4')
# lambda_plot(find_lambda_s2_third12_1000_4)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD12_4",".rds")
find_lambda_s2_third12_1000_4 <- readRDS(file_name)
lambdas_third_12=lambda_plot(find_lambda_s2_third12_1000_4,'Datasets simulated using rank 1, \n models fitted using rank 2')$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third12_1000_4$results_df$lambda -  3.41e-3 ) < 1e-8)
mean(find_lambda_s2_third12_1000_4$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# lambda_opt=lambda_plot(find_lambda_s2_third12_1000)$lambda_opt
# 
# performance_results_s2_third12_1000 = simulations_fit_and_preformance(datas_s2_third1_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'THIRD12')
```




```{r}
file_name <- paste0("simulation_progress_expTHIRD12_0.00341_",".rds")
performance_results_s2_third12_1000 <- readRDS(file_name)

performance_results_s2_third12_1000$bias3_df <- do.call(rbind, performance_results_s2_third12_1000$bias3_list)
performance_results_s2_third12_1000$mse3_df <- do.call(rbind, performance_results_s2_third12_1000$mse3_list)

colnames(performance_results_s2_third12_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third12_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third12_1000$est_Gammamatrix_list, is.null))
```

##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third12_1000
title = "Fitted under rank 2"
Beta_true=third1_beta_true
  
beta_heat2_3_12=beta_heatmap(title,Beta_true, performance_results,-0.0113,0.00948,minmax = TRUE)

```

##### Plot performance

```{r}
r_s2_third12_1000 = generate_histograms(performance_results_s2_third11_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_third11_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third11_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third12_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third11_1000$lp_errors, as.vector))

MC_error_lp_third12_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


## Call functions to simulate n_simulation=100 datasets using rank r=2 with random zeros

```{r}
#set seed
set.seed(123)

r <- 2  # Rank of simulated data

datas_s2_third2_1000 = simulations_data(n,p,r,k,n_simulations,case=3,corr = 0.1)

rank_check(datas_s2_third2_1000$Beta_matrix)

third2_beta_true=datas_s2_third2_1000$Beta_matrix

colnames(third2_beta_true) <- paste("k=", 1:ncol(third2_beta_true), sep="")
rownames(third2_beta_true) <- paste("X", 1:nrow(third2_beta_true), sep="")
beta_df <- reshape2::melt(third2_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(third2_beta_true), max(third2_beta_true), length.out = 101)
breaks <- seq(-2.208e-06,0.0163, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_3_2 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 2")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_third2_1000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_third2_1000$T_sim,
#                     T_obs=datas_s2_third2_1000$T_obs)

third_2_1000= generate_data_plots(datas_s2_third2_1000$dlong_list,n,r,p,k,3,0.1,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (not penalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(5.29e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third21_1000 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD21')
# lambda_plot(find_lambda_s2_third21_1000)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD21",".rds")
find_lambda_s2_third21_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third21_1000)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_third21_1000$results_df$lambda -  7.333207e-04 ) < 1e-8)
mean(find_lambda_s2_third21_1000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.017e-4), log10(5.29e-3), n =  6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third21_1000_2 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD21_2')
# lambda_plot(find_lambda_s2_third21_1000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD21_2",".rds")
find_lambda_s2_third21_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third21_1000_2)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third21_1000_2$results_df$lambda -  0.0024000966 ) < 1e-8)
mean(find_lambda_s2_third21_1000_2$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.4e-3), log10(5.29e-3), n =  4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third21_1000_3 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD21_3')
# lambda_plot(find_lambda_s2_third21_1000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD21_3",".rds")
find_lambda_s2_third21_1000_3 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third21_1000_3)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third21_1000_3$results_df$lambda -  0.004064816  ) < 1e-8)
mean(find_lambda_s2_third21_1000_3$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(4.065e-3), log10(5.29e-3), n =  4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third21_1000_4 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR1,p,k,R2,'THIRD21_4')
# lambda_plot(find_lambda_s2_third21_1000_4)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD21_4",".rds")
find_lambda_s2_third21_1000_4 <- readRDS(file_name)


lambdas_third_21=lambda_plot(find_lambda_s2_third21_1000_4,'Datasets simulated using rank 2, \n models fitted using rank 1')$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third21_1000_4$results_df$lambda -    0.004845337 ) < 1e-8)
mean(find_lambda_s2_third21_1000_4$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_third21_1000)$lambda_opt
# 
# performance_results_s2_third21_1000 = simulations_fit_and_preformance(datas_s2_third2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'THIRD21')
```




```{r}
file_name <- paste0("simulation_progress_expTHIRD21_0.004845337_",".rds")
performance_results_s2_third21_1000 <- readRDS(file_name)

performance_results_s2_third21_1000$bias3_df <- do.call(rbind, performance_results_s2_third21_1000$bias3_list)
performance_results_s2_third21_1000$mse3_df <- do.call(rbind, performance_results_s2_third21_1000$mse3_list)

colnames(performance_results_s2_third21_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third21_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third21_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third21_1000
title = "Fitted under rank 1"
Beta_true=third2_beta_true
  
beta_heat2_3_21=beta_heatmap(title,Beta_true, performance_results,-2.208e-06,0.0163,minmax=TRUE)

```

##### Plot performance

```{r}
r_s2_third21_1000 = generate_histograms(performance_results_s2_third21_1000, k)
```

##### ΜC ERRORS

```{r}

msesmc = unlist(lapply(performance_results_s2_third21_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third21_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third21_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third21_1000$lp_errors, as.vector))

MC_error_lp_third21_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(7.02e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third22_1000 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD22')
# lambda_plot(find_lambda_s2_third22_1000)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD22",".rds")
find_lambda_s2_third22_1000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third22_1000)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third22_1000$results_df$lambda -  9.430221e-04 ) < 1e-8)
mean(find_lambda_s2_third22_1000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(9.43e-4), log10(7.02e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third22_1000_2 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD22_2')
# lambda_plot(find_lambda_s2_third22_1000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD22_2",".rds")
find_lambda_s2_third22_1000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third22_1000_2)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third22_1000_2$results_df$lambda -  0.003595246 ) < 1e-8)
mean(find_lambda_s2_third22_1000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(3.595e-3), log10(7.02e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# # 
# # find_lambda_s2_third22_1000_3 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD22_3')
# # lambda_plot(find_lambda_s2_third22_1000_3)$lam_plot
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD22_3",".rds")
find_lambda_s2_third22_1000_3 <- readRDS(file_name)


lambdas_third_22=lambda_plot(find_lambda_s2_third22_1000_3,'Datasets simulated using rank 2, \n models fitted using rank 2')$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third22_1000_3$results_df$lambda -  0.005616396   ) < 1e-8)
mean(find_lambda_s2_third22_1000_3$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(4.493e-3), log10(5.616e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third22_1000_4 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR2,p,k,R2,'THIRD22_4')
# lambda_plot(find_lambda_s2_third22_1000_4)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD22_4",".rds")
find_lambda_s2_third22_1000_4 <- readRDS(file_name)

lambda_plot(find_lambda_s2_third22_1000_4)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_third22_1000_4$results_df$lambda -  lambda_plot(find_lambda_s2_third22_1000_4)$lambda_opt   ) < 1e-8)
mean(find_lambda_s2_third22_1000_4$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=0.005616396
#   
# performance_results_s2_third22_1000 = simulations_fit_and_preformance(datas_s2_third2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'THIRD22_0.005616396')
```





```{r}
file_name <- paste0("simulation_progress_expTHIRD22_0.005616396",".rds")
performance_results_s2_third22_1000 <- readRDS(file_name)

performance_results_s2_third22_1000$bias3_df <- do.call(rbind, performance_results_s2_third22_1000$bias3_list)
performance_results_s2_third22_1000$mse3_df <- do.call(rbind, performance_results_s2_third22_1000$mse3_list)

colnames(performance_results_s2_third22_1000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third22_1000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third22_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third22_1000
title = "Fitted under rank 2"
Beta_true=third2_beta_true
  
beta_heat2_3_22=beta_heatmap(title,Beta_true, performance_results,-2.208e-06,0.0163,minmax=TRUE)

```
##### Plot performance

```{r}
r_s2_third22_1000 = generate_histograms(performance_results_s2_third22_1000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_third22_1000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third22_1000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third22_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third22_1000$lp_errors, as.vector))

MC_error_lp_third22_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(6.59e-3), n = 10)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third23_1000 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR3,p,k,R2,'THIRD23')
# 
# 
# lambda_plot(find_lambda_s2_third23_1000)$lam_plot

```




```{r}
# file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD23",".rds")
# find_lambda_s2_third23_1000 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_third23_1000)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_third23_1000$results_df$lambda -  8.914980e-04 ) < 1e-8)
# mean(find_lambda_s2_third23_1000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(8.915e-4), log10(6.59e-3), n = 4)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third23_1000_2 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR3,p,k,R2,'THIRD23_2')
# 
# 
#   lambda_plot(find_lambda_s2_third23_1000_2)$lam_plot

```



```{r}
# file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD23_2",".rds")
# find_lambda_s2_third23_1000_2 <- readRDS(file_name)
# 
#   lambda_plot(find_lambda_s2_third23_1000_2)$lam_plot
```



```{r}
# indexes=which(abs(find_lambda_s2_third23_1000_2$results_df$lambda -  0.003382964  ) < 1e-8)
# mean(find_lambda_s2_third23_1000_2$results_df$ave_lp[indexes])
```



#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(3.383e-3), log10(6.59e-3), n = 4)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third23_1000_3 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR3,p,k,R2,'THIRD23_3')
# 
# 
#   lambda_plot(find_lambda_s2_third23_1000_3)$lam_plot

```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD23_3",".rds")
# find_lambda_s2_third23_1000_3 <- readRDS(file_name)
# 
#   lambda_plot(find_lambda_s2_third23_1000_3)$lam_plot
```



```{r}
# indexes=which(abs(find_lambda_s2_third23_1000_3$results_df$lambda -  0.005276642    ) < 1e-8)
# mean(find_lambda_s2_third23_1000_3$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_1000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_1000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_1000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_1000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(4.22e-3), log10(5.277e-3), n = 4)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third23_1000_4 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR3,p,k,R2,'THIRD23_4')
# 
# 
#   lambda_plot(find_lambda_s2_third23_1000_4)$lam_plot

```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldatasetTHIRD23_4",".rds")
# find_lambda_s2_third23_1000_4 <- readRDS(file_name)
# 
#   lambda_plot(find_lambda_s2_third23_1000_4)$lam_plot
```



```{r}
# indexes=which(abs(find_lambda_s2_third23_1000_4$results_df$lambda -   0.004898114   ) < 1e-8)
# mean(find_lambda_s2_third23_1000_4$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=3

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# 
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_third23_1000)$lambda_opt
# 
# performance_results_s2_third23_1000 = simulations_fit_and_preformance(datas_s2_third2_1000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR3, Print_flug,'THIRD23')
```



```{r}
# file_name <- paste0("simulation_progress_expTHIRD23_0.004898114 _",".rds")
# performance_results_s2_third23_1000 <- readRDS(file_name)
# 
# performance_results_s2_third23_1000$bias3_df <- do.call(rbind, performance_results_s2_third23_1000$bias3_list)
# performance_results_s2_third23_1000$mse3_df <- do.call(rbind, performance_results_s2_third23_1000$mse3_list)
# 
# colnames(performance_results_s2_third23_1000$bias3_df) <- paste0("Outcome_", 1:k)
# colnames(performance_results_s2_third23_1000$mse3_df) <- paste0("Outcome_", 1:k)
# 
# sum(sapply(performance_results_s2_third23_1000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
# performance_results=performance_results_s2_third23_1000
# title = "Fitted under rank 3"
# Beta_true=third2_beta_true
#   
# beta_heat2_3_23=beta_heatmap(title,Beta_true, performance_results)

```


##### Plot performance

```{r}
# r_s2_third23_1000 = generate_histograms(performance_results_s2_third23_1000, k)
```

##### ΜC ERRORS

```{r}
# msesmc = unlist(lapply(performance_results_s2_third23_1000$mse_for_all_coeffs, as.vector))
# biasmc = unlist(lapply(performance_results_s2_third23_1000$bias_for_all_coeffs, as.vector))
# MC_errors_s2_third23_1000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
# lp_errors_mc = unlist(lapply(performance_results_s2_third23_1000$lp_errors, as.vector))
# 
# MC_error_lp_third23_1000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


### Heatmaps

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=heatmapreal2_3_1
plot_listf1[[2]]=beta_heat2_3_11
plot_listf1[[3]]=beta_heat2_3_12
# plot_listf1[[4]]=NULL
plot_listf1[[4]]=heatmapreal2_3_2
plot_listf1[[5]]=beta_heat2_3_21
plot_listf1[[6]]=beta_heat2_3_22
# plot_listf1[[8]]=NULL

top=''

heatmaps_3 <- grid.arrange(grobs = plot_listf1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("heatmaps2_1000_3.png", plot = heatmaps_3, width = 23, height = 6, dpi = 300)
```

### EXAMPLELambda plots

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=lambdas_third_11_1
plot_listf1[[2]]=lambdas_third_11_2
plot_listf1[[3]]=lambdas_third_11_3
plot_listf1[[4]]=lambdas_third_11_4

top <- textGrob(
  "Datasets simulated using rank 1, \n models fitted using rank 1", 
  gp = gpar(fontsize = 25) 
)
top=''

lambdas_3_1000_ex <- grid.arrange(grobs = plot_listf1, ncol = 2, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("lambdas_3_1000_ex.png", plot = lambdas_3_1000_ex,  width = 17, height = 7, dpi = 300)
```

### Lambda plots

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=lambdas_third_11
plot_listf1[[2]]=lambdas_third_12
plot_listf1[[3]]=lambdas_third_21
plot_listf1[[4]]=lambdas_third_22

top=''

lambdas_3_1000 <- grid.arrange(grobs = plot_listf1, ncol = 2, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("lambdas_3_1000.png", plot = lambdas_3_1000,  width = 17, height = 7, dpi = 300)
```


#5000

# FIRST Configuration (sample size:5000, p=300,K=8,n_simulation=100-rangom case, but corelated with 0.7 corelation)

## Call functions to simulate n_simulation=100 datasets using rank r=1

```{r}
#set seed
set.seed(123)
#chose variables
n = 5000   # Number of observations
p <- 300  # Number of covariates
k <- 8  # Number of outcomes
n_simulations = 100

r <- 1  # Rank of simulated data

datas_s2_First1_5000 = simulations_data(n,p,r,k,n_simulations,case = 1,cor=0.7)
rank_check(datas_s2_First1_5000$Beta_matrix)

first1_5000_beta_true=datas_s2_First1_5000$Beta_matrix 

colnames(first1_5000_beta_true) <- paste("k=", 1:ncol(first1_5000_beta_true), sep="")
rownames(first1_5000_beta_true) <- paste("X", 1:nrow(first1_5000_beta_true), sep="")
beta_df <- reshape2::melt(first1_5000_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(first1_5000_beta_true), max(first1_5000_beta_true), length.out = 101)
breaks <- seq(-0.00332, 0.0099, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_1_1_5000 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 1")
```


### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_First1_5000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_First1_5000$T_sim,
#                     T_obs=datas_s2_First1_5000$T_obs)

first_1_5000= generate_data_plots(datas_s2_First1_5000$dlong_list,n,r,p,k,1,0.7,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS

#### Fit 5 first datasets to find best lambda   #okok
```{r}
# #set seed
# set.seed(123)
# #
# R2 = 1 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_5000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_5000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_5000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(8.85e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first11_5000 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR1,p,k,R2,'5000FIRST11')
# 
# lambda_plot(  find_lambda_s2_first11_5000)$lam_plot
# find_lambda_s2_first11_5000$results_df

```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST11",".rds")
find_lambda_s2_first11_5000 <- readRDS(file_name)

lambda_plot(  find_lambda_s2_first11_5000)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first11_5000$results_df$lambda - lambda_plot(  find_lambda_s2_first11_5000)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_first11_5000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok
```{r}
# #set seed
# set.seed(123)
# #
# R2 = 1 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_5000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_5000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_5000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1.517e-4), log10(8.85e-3), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first11_5000_2 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR1,p,k,R2,'5000FIRST11_2')
# 
# lambda_plot(  find_lambda_s2_first11_5000_2)$lam_plot
# find_lambda_s2_first11_5000_2$results_df

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST11_2",".rds")
find_lambda_s2_first11_5000_2 <- readRDS(file_name)

lambda_plot(  find_lambda_s2_first11_5000_2)$lam_plot
```



```{r}
indexes=which(abs(find_lambda_s2_first11_5000_2$results_df$lambda -  0.0017400439   ) < 1e-8)
mean(find_lambda_s2_first11_5000_2$results_df$ave_lp[indexes])
```
#### --Fit 5 first datasets to find best lambda   #okok
```{r}
# #set seed
# set.seed(123)
# #
# R2 = 1 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_5000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_5000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_5000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(7.716e-4), log10(3.924e-3), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first11_5000_3 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR1,p,k,R2,'5000FIRST11_3')
# 
# lambda_plot(  find_lambda_s2_first11_5000_3)$lam_plot
# find_lambda_s2_first11_5000_3$results_df

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST11_3",".rds")
find_lambda_s2_first11_5000_3 <- readRDS(file_name)


lambdas_first_11_5000=lambda_plot(find_lambda_s2_first11_5000_3,'Datasets simulated using rank 1, \n models fitted using rank 1')$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first11_5000_3$results_df$lambda -    0.00147886) < 1e-8)
mean(find_lambda_s2_first11_5000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(  find_lambda_s2_first11_5000)$lambda_opt
# 
# performance_results_s2_first11_5000 = simulations_fit_and_preformance(datas_s2_First1_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'5000FIRST11')

```




```{r}
file_name <- paste0("simulation_progress_exp5000FIRST11_0.00147886ALL",".rds")
performance_results_s2_first11_5000 <- readRDS(file_name)

sum(sapply(performance_results_s2_first11_5000$est_Gammamatrix_list, is.null))
```

##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first11_5000
title = "Fitted under rank 1"
Beta_true=first1_5000_beta_true
  
beta_heat2_5000_1_11=beta_heatmap(title,Beta_true, performance_results,-0.00332, 0.0099,minmax=TRUE)

```


##### Plot performance

```{r}
r_s2_first11_5000 = generate_histograms(performance_results_s2_first11_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_first11_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first11_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first11_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_first11_5000$lp_errors, as.vector))

MC_error_lp_first11_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_5000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_5000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_5000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(1.66e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first12_5000 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR2,p,k,R2,'5000FIRST12')
# 
# lambda_plot(find_lambda_s2_first12_5000)$lam_plot
# find_lambda_s2_first12_5000$results_df
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST12",".rds")
find_lambda_s2_first12_5000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first12_5000)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first12_5000$results_df$lambda - lambda_plot(  find_lambda_s2_first12_5000)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_first12_5000$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_5000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_5000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_5000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(2.167e-4), log10(1.66e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first12_5000_2 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR2,p,k,R2,'5000FIRST12_2')
# 
# lambda_plot(find_lambda_s2_first12_5000_2)$lam_plot
# find_lambda_s2_first12_5000_2$results_df
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST12_2",".rds")
find_lambda_s2_first12_5000_2 <- readRDS(file_name)


lambdas_first_12_5000=lambda_plot(find_lambda_s2_first12_5000_2,'Datasets simulated using rank 1, \n models fitted using rank 2')$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first12_5000_2$results_df$lambda - 1.66e-3) < 1e-8)
mean(find_lambda_s2_first12_5000_2$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_z <- list()
# datasets_list_z$dlong_list <- datas_s2_First1_5000$dlong_list[1:5]
# datasets_list_z$Beta_matrix <- datas_s2_First1_5000$Beta_matrix
# datasets_list_z$simulation_times <- datas_s2_First1_5000$simulation_times[1:5]
# datasets_list_z$X_list <- datas_s2_First1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(8.421e-4), log10(1.66e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first12_5000_3 = simulations_fit_find_best_lambda(datasets_list_z,lambda_vector,Gamma.startR2,p,k,R2,'5000FIRST12_3')
# 
# lambda_plot(find_lambda_s2_first12_5000_3)$lam_plot
# find_lambda_s2_first12_5000_3$results_df
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST12_3",".rds")
find_lambda_s2_first12_5000_3 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first12_5000_3)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first12_5000_3$results_df$lambda -    lambda_plot(find_lambda_s2_first12_5000_3)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_first12_5000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_first12_5000)$lambda_opt
# 
# performance_results_s2_first12_5000 = simulations_fit_and_preformance(datas_s2_First1_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'5000FIRST12')
```



```{r}
file_name <- paste0("simulation_progress_exp5000FIRST12_0.00166ALL",".rds")
performance_results_s2_first12_5000 <- readRDS(file_name)

sum(sapply(performance_results_s2_first12_5000$est_Gammamatrix_list, is.null))
```

##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first12_5000
title = "Fitted under rank 2"
Beta_true=first1_5000_beta_true
  
beta_heat2_5000_1_12=beta_heatmap(title,Beta_true, performance_results,-0.00332, 0.0099,minmax=TRUE)

```
##### Plot performance

```{r}
r_s2_first12_5000 = generate_histograms(performance_results_s2_first12_5000, k)
```

##### ΜC ERRORS

```{r}

msesmc = unlist(lapply(performance_results_s2_first12_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first12_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first12_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}

lp_errors_mc = unlist(lapply(performance_results_s2_first12_5000$lp_errors, as.vector))

MC_error_lp_first12_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


## Call functions to simulate n_simulation=100 datasets using rank r=2

```{r}
#set seed
set.seed(123)

r <- 2  # Rank of simulated data

datas_s2_First2_5000 = simulations_data(n,p,r,k,n_simulations,case=1,corr = 0.7)

rank_check(datas_s2_First2_5000$Beta_matrix)

first2_5000_beta_true=datas_s2_First2_5000$Beta_matrix

colnames(first2_5000_beta_true) <- paste("k=", 1:ncol(first2_5000_beta_true), sep="")
rownames(first2_5000_beta_true) <- paste("X", 1:nrow(first2_5000_beta_true), sep="")
beta_df <- reshape2::melt(first2_5000_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(first2_5000_beta_true), max(first2_5000_beta_true), length.out = 101)
breaks <- seq(0.000101, 0.0172, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_1_2_5000 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 2")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_First2_5000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_First2_5000$T_sim,
#                     T_obs=datas_s2_First2_5000$T_obs)

first_2_5000= generate_data_plots(datas_s2_First2_5000$dlong_list,n,r,p,k,1,0.7,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS

#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(1.41e-2), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first21_5000 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR1,p,k,R2,'5000FIRST21')
# 
# lambda_plot(find_lambda_s2_first21_5000 )$lam_plot
# find_lambda_s2_first21_5000$results_df
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST21",".rds")
find_lambda_s2_first21_5000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first21_5000 )$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_first21_5000$results_df$lambda -  1.752872e-03 ) < 1e-8)
mean(find_lambda_s2_first21_5000$results_df$ave_lp[indexes])
```
#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.179e-4), log10(1.41e-2), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first21_5000_2 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR1,p,k,R2,'5000FIRST21_2')

```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST21_2",".rds")
find_lambda_s2_first21_5000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first21_5000_2)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first21_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_first21_5000_2)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_first21_5000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.155e-3), log10(2.66e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# # find_lambda_s2_first21_5000_3 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR1,p,k,R2,'5000FIRST21_3')

```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST21_3",".rds")
find_lambda_s2_first21_5000_3 <- readRDS(file_name)


lambdas_first_21_5000=lambda_plot(find_lambda_s2_first21_5000_3,'Datasets simulated using rank 2, \n models fitted using rank 1')$lam_plot

```


```{r}
indexes=which(abs(find_lambda_s2_first21_5000_3$results_df$lambda -    0.002014258 ) < 1e-8)
mean(find_lambda_s2_first21_5000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance


```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# lambda_opt=0.002014258
# 
# performance_results_s2_first21_5000 = simulations_fit_and_preformance(datas_s2_1y_first100,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'5000FIRST21_0.002014258')
```



```{r}
file_name <- paste0("simulation_progress_exp5000FIRST21_0.002014258ALL",".rds")
performance_results_s2_first21_5000 <- readRDS(file_name)


sum(sapply(performance_results_s2_first21_5000$est_Gammamatrix_list, is.null))
```




##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first21_5000
title = "Fitted under rank 1"
Beta_true=first2_5000_beta_true
  
beta_heat2_5000_1_21=beta_heatmap(title,Beta_true, performance_results,0.000101, 0.0172,minmax=TRUE)

```


##### Plot performance

```{r}
r_s2_first21_5000 = generate_histograms(performance_results_s2_first21_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_first21_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first21_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first21_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}

lp_errors_mc = unlist(lapply(performance_results_s2_first21_5000$lp_errors, as.vector))

MC_error_lp_first21_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(2.47e-2), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first22_5000 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR2,p,k,R2,'5000FIRST22')
# 
# lambda_plot(find_lambda_s2_first22_5000 )$lam_plot
# find_lambda_s2_first22_5000$results_df
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST22",".rds")
find_lambda_s2_first22_5000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first22_5000 )$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first22_5000$results_df$lambda -2.885194e-03 ) < 1e-8)
mean(find_lambda_s2_first22_5000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(3.37e-4), log10(2.47e-2), n = 6)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first22_5000_2 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR2,p,k,R2,'5000FIRST22_2')
# 
# lambda_plot(find_lambda_s2_first22_5000_2 )$lam_plot
# find_lambda_s2_first22_5000_2$results_df
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST22_2",".rds")
find_lambda_s2_first22_5000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_first22_5000_2)$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first22_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_first22_5000_2)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_first22_5000_2$results_df$ave_lp[indexes])
```
#### --Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.87e-3), log10(4.433e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first22_5000_3 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR2,p,k,R2,'5000FIRST22_3')
# 
# lambda_plot(find_lambda_s2_first22_5000_3 )$lam_plot
# find_lambda_s2_first22_5000_3$results_df
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST22_3",".rds")
find_lambda_s2_first22_5000_3 <- readRDS(file_name)


lambdas_first_22_5000=lambda_plot(find_lambda_s2_first22_5000_3,'Datasets simulated using rank 2, \n models fitted using rank 2')$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_first22_5000_3$results_df$lambda -    0.00249341) < 1e-8)
mean(find_lambda_s2_first22_5000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_first22_5000)$lambda_opt
# 
# performance_results_s2_first22_5000 = simulations_fit_and_preformance(datas_s2_First2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'5000_FIRST22')
```



```{r}
file_name <- paste0("simulation_progress_exp5000_FIRST22_0.00249341ALL",".rds")
performance_results_s2_first22_5000 <- readRDS(file_name)


sum(sapply(performance_results_s2_first22_5000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_first22_5000
title = "Fitted under rank 2"
Beta_true=first2_5000_beta_true
  
beta_heat2_5000_1_22=beta_heatmap(title,Beta_true, performance_results,0.000101, 0.0172,minmax=TRUE)

```
##### Plot performance

```{r}
r_s2_first22_5000 = generate_histograms(performance_results_s2_first22_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_first22_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_first22_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_first22_5000 = MC_errors_calc(msesmc,biasmc)
```



##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_first22_5000$lp_errors, as.vector))

MC_error_lp_first22_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```



#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(2.71e-2), n = 10)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first23_5000 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR3,p,k,R2,'5000FIRST23')
# lambda_plot(find_lambda_s2_first23_5000)$lam_plot
# find_lambda_s2_first23_5000$results_df
```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST23",".rds")
# find_lambda_s2_first23_5000 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_first23_5000)$lam_plot
```

```{r}
# indexes=which(abs(find_lambda_s2_first23_5000$results_df$lambda - lambda_plot(  find_lambda_s2_first23_5000)$lambda_opt ) < 1e-8)
# mean(find_lambda_s2_first23_5000$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(3.622e-4), log10(2.71e-2), n = 6)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first23_5000_2 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR3,p,k,R2,'5000FIRST23_2')
# lambda_plot(find_lambda_s2_first23_5000_2)$lam_plot
# find_lambda_s2_first23_5000_2$results_df
```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST23_2",".rds")
# find_lambda_s2_first23_5000_2 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_first23_5000_2)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_first23_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_first23_5000_2)$lambda_opt ) < 1e-8)
# mean(find_lambda_s2_first23_5000_2$results_df$ave_lp[indexes])
```
#### Fit 5 first datasets to find best lambda #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2z <- list()
# datasets_list_2z$dlong_list <- datas_s2_First2_5000$dlong_list[1:5]
# datasets_list_2z$Beta_matrix <- datas_s2_First2_5000$Beta_matrix
# datasets_list_2z$simulation_times <- datas_s2_First2_5000$simulation_times[1:5]
# datasets_list_2z$X_list <- datas_s2_First2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(8.585e-4), log10(4.82e-3), n = 6)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_first23_5000_3 = simulations_fit_find_best_lambda(datasets_list_2z,lambda_vector,Gamma.startR3,p,k,R2,'5000FIRST23_3')
# lambda_plot(find_lambda_s2_first23_5000_3)$lam_plot
# find_lambda_s2_first23_5000_3$results_df
```



```{r}
# file_name <- paste0("simulation_lambdas_expfulldataset5000FIRST23_3",".rds")
# find_lambda_s2_first23_5000_3 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_first23_5000_3)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_first23_5000_3$results_df$lambda -    lambda_plot(find_lambda_s2_first23_5000_3)$lambda_opt ) < 1e-8)
# mean(find_lambda_s2_first23_5000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=3

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# 
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_first23_5000)$lambda_opt
# 
# performance_results_s2_first23_5000 = simulations_fit_and_preformance(datas_s2_First2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR3, Print_flug, '5000_FIRST23')
```

##### Get average beta heatmap

```{r}
# performance_results=performance_results_s2_first23_5000
# title = "Fitted under rank 3"
# Beta_true=first2_5000_beta_true
#   
# beta_heat2_5000_1_23=beta_heatmap(title,Beta_true, performance_results)

```

##### Plot performance

```{r}
# r_s2_first23_5000 = generate_histograms(performance_results_s2_FIRST23ALL_5000, k)
```

##### ΜC ERRORS

```{r}
# msesmc = unlist(lapply(performance_results_s2_FIRST23ALL_5000$mse_for_all_coeffs, as.vector))
# biasmc = unlist(lapply(performance_results_s2_FIRST23ALL_5000$bias_for_all_coeffs, as.vector))
# MC_errors_s2_FIRST23_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
# lp_errors_mc = unlist(lapply(performance_results_s2_FIRST23ALL_5000$lp_errors, as.vector))
# 
# MC_error_lp_FIRST23_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

### Heatmaps

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=heatmapreal2_1_1_5000
plot_listf1[[2]]=beta_heat2_5000_1_11
plot_listf1[[3]]=beta_heat2_5000_1_12
# plot_listf1[[4]]=NULL
plot_listf1[[4]]=heatmapreal2_1_2_5000
plot_listf1[[5]]=beta_heat2_5000_1_21
plot_listf1[[6]]=beta_heat2_5000_1_22
# plot_listf1[[8]]=NULL

top=''

heatmaps_1_5000 <- grid.arrange(grobs = plot_listf1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("heatmaps2_5000_1.png", plot = heatmaps_1_5000, width = 23, height = 6, dpi = 300)
```

### Lambda plots

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=lambdas_first_11_5000
plot_listf1[[2]]=lambdas_first_12_5000
plot_listf1[[3]]=lambdas_first_21_5000
plot_listf1[[4]]=lambdas_first_22_5000

top=''

lambdas_1_5000 <- grid.arrange(grobs = plot_listf1, ncol = 2, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("lambdas_1_5000.png", plot = lambdas_1_5000, width = 17, height = 7, dpi = 300)
```

# SECOND Configuration (sample size:5000, p=300,K=8,n_simulation=100-case with half predictors for each outcome zeros and cor=0.7)

Fit only three unpenalized data to show that needs much time

## Call functions to simulate n_simulation=100 datasets using rank r=1 with half predictors be zeros

```{r}
#set seed
set.seed(123)
#chose variables
n = 5000   # Number of observations
p <- 300  # Number of covariates
k <- 8  # Number of outcomes
n_simulations = 100

r <- 1  # Rank of simulated data

datas_s2_second1_5000 = simulations_data(n,p,r,k,n_simulations,case = 2,corr = 0.7)

rank_check(datas_s2_second1_5000$Beta_matrix)

second1_5000_beta_true=datas_s2_second1_5000$Beta_matrix

colnames(second1_5000_beta_true) <- paste("k=", 1:ncol(second1_5000_beta_true), sep="")
rownames(second1_5000_beta_true) <- paste("X", 1:nrow(second1_5000_beta_true), sep="")
beta_df <- reshape2::melt(second1_5000_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(second1_5000_beta_true), max(second1_5000_beta_true), length.out = 101)
breaks <- seq(-0.012 ,0.0158, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_2_1_5000 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 1")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_second1_5000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_second1_5000$T_sim,
#                     T_obs=datas_s2_second1_5000$T_obs)

second_1_5000=generate_data_plots(datas_s2_second1_5000$dlong_list,n,r,p,k,2,0.7,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (no unpenalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_5000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_5000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_5000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(1.40e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second11_5000 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR1,p,k,R2,'5000SECOND11')
# 
# lambda_plot(find_lambda_s2_second11_5000)
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND11",".rds")
find_lambda_s2_second11_5000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second11_5000)
```

```{r}
indexes=which(abs(find_lambda_s2_second11_5000$results_df$lambda - 2.249644e-04 ) < 1e-8)
mean(find_lambda_s2_second11_5000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_5000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_5000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_5000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(2.25e-4), log10(1.40e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second11_5000_2 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR1,p,k,R2,'5000SECOND11_2')
# 
# lambda_plot(find_lambda_s2_second11_5000_2)
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND11_2",".rds")
find_lambda_s2_second11_5000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second11_5000_2)
```

```{r}
indexes=which(abs(find_lambda_s2_second11_5000_2$results_df$lambda - 0.0007611663  ) < 1e-8)
mean(find_lambda_s2_second11_5000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_5000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_5000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_5000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(7.612e-4), log10(1.40e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second11_5000_3 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR1,p,k,R2,'5000SECOND11_3')
# 
# lambda_plot(find_lambda_s2_second11_5000_3)
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND11_3",".rds")
find_lambda_s2_second11_5000_3 <- readRDS(file_name)

lambdas_second_11_5000=lambda_plot(find_lambda_s2_second11_5000_3,'Datasets simulated using rank 1, \n models fitted using rank 1')$lam_plot
```


```{r}
indexes=which(abs(find_lambda_s2_second11_5000_3$results_df$lambda -    0.0011426633 ) < 1e-8)
mean(find_lambda_s2_second11_5000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second11_5000)$lambda_opt
#   
# performance_results_s2_second11_5000 = simulations_fit_and_preformance(datas_s2_second1_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'5000_SECOND11')
```


```{r}
file_name <- paste0("simulation_progress_exp5000_SECOND11_0.0011426633",".rds")
performance_results_s2_second11_5000 <- readRDS(file_name)

performance_results_s2_second11_5000$bias3_df <- do.call(rbind, performance_results_s2_second11_5000$bias3_list)
performance_results_s2_second11_5000$mse3_df <- do.call(rbind, performance_results_s2_second11_5000$mse3_list)

colnames(performance_results_s2_second11_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second11_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second11_5000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second11_5000
title = "Fitted under rank 1"
Beta_true=second1_5000_beta_true
  
beta_heat2_5000_2_11=beta_heatmap(title,Beta_true, performance_results,-0.012 ,0.0158,minmax=TRUE)

```

##### Plot performance

```{r}
r_s2_second11_5000 = generate_histograms(performance_results_s2_second11_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_second11_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second11_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second11_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second11_5000$lp_errors, as.vector))

MC_error_lp_second11_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_5000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_5000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_5000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(9.94e-4), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second12_5000 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR2,p,k,R2,'5000SECOND12')
# 
# 
# lambda_plot(find_lambda_s2_second12_5000)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND12",".rds")
find_lambda_s2_second12_5000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second12_5000)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second12_5000$results_df$lambda - 1.659201e-04 )< 1e-8)
mean(find_lambda_s2_second12_5000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_5000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_5000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_5000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.659e-4), log10(9.94e-4), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second12_5000_2 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR2,p,k,R2,'5000SECOND12_2')
# 
# 
# lambda_plot(find_lambda_s2_second12_5000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND12_2",".rds")
find_lambda_s2_second12_5000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second12_5000_2)
```

```{r}
indexes=which(abs(find_lambda_s2_second12_5000_2$results_df$lambda - 0.0005472760  ) < 1e-8)
mean(find_lambda_s2_second12_5000_2$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_y <- list()
# datasets_list_y$dlong_list <- datas_s2_second1_5000$dlong_list[1:5]
# datasets_list_y$Beta_matrix <- datas_s2_second1_5000$Beta_matrix
# datasets_list_y$simulation_times <- datas_s2_second1_5000$simulation_times[1:5]
# datasets_list_y$X_list <- datas_s2_second1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(5.473e-4), log10(9.94e-4), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second12_5000_3 = simulations_fit_find_best_lambda(datasets_list_y,lambda_vector,Gamma.startR2,p,k,R2,'5000SECOND12_3')
# 
# 
# lambda_plot(find_lambda_s2_second12_5000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND12_3",".rds")
find_lambda_s2_second12_5000_3 <- readRDS(file_name)

lambdas_second_12_5000=lambda_plot(find_lambda_s2_second12_5000_3,'Datasets simulated using rank 1, \n models fitted using rank 2')$lam_plot

```

```{r}
indexes=which(abs(find_lambda_s2_second12_5000_3$results_df$lambda -  0.0008147032 ) < 1e-8)
mean(find_lambda_s2_second12_5000_3$results_df$ave_lp[indexes])
```
#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second12_5000)$lambda_opt
# 
# performance_results_s2_second12_5000 = simulations_fit_and_preformance(datas_s2_second1_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'5000_SECOND12')

```



```{r}
file_name <- paste0("simulation_progress_exp5000_SECOND12_0.0008147032",".rds")
performance_results_s2_second12_5000 <- readRDS(file_name)

performance_results_s2_second12_5000$bias3_df <- do.call(rbind, performance_results_s2_second12_5000$bias3_list)
performance_results_s2_second12_5000$mse3_df <- do.call(rbind, performance_results_s2_second12_5000$mse3_list)

colnames(performance_results_s2_second12_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second12_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second12_5000$est_Gammamatrix_list, is.null))
```

##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second12_5000
title = "Fitted under rank 2"
Beta_true=second1_5000_beta_true
  
beta_heat2_5000_2_12=beta_heatmap(title,Beta_true, performance_results,-0.012 ,0.0158,minmax=TRUE)

```

##### Plot performance

```{r}
r_s2_second12_5000 = generate_histograms(performance_results_s2_second12_5000, k)
```

##### ΜC ERRORS

```{r}

msesmc = unlist(lapply(performance_results_s2_second12_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second12_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second12_5000 = MC_errors_calc(msesmc,biasmc)
```



##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second12_5000$lp_errors, as.vector))

MC_error_lp_second12_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

## Call functions to simulate n_simulation=100 datasets using rank r=2 with half predictors be zeros

```{r}
#set seed
set.seed(123)

r <- 2  # Rank of simulated data

datas_s2_second2_5000 = simulations_data(n,p,r,k,n_simulations,case=2,corr = 0.7)

rank_check(datas_s2_second2_5000$Beta_matrix)

second2_5000_beta_true=datas_s2_second2_5000$Beta_matrix

colnames(second2_5000_beta_true) <- paste("k=", 1:ncol(second2_5000_beta_true), sep="")
rownames(second2_5000_beta_true) <- paste("X", 1:nrow(second2_5000_beta_true), sep="")
beta_df <- reshape2::melt(second2_5000_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(second2_5000_beta_true), max(second2_5000_beta_true), length.out = 101)
breaks <- seq(-0.00166, 0.00975, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_2_2_5000 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 2")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_second2_5000$dlong_list,n,r,p,k,
#                     T_sim=datas_s2_second2_5000$T_sim,
#                     T_obs=datas_s2_second2_5000$T_obs)

second_2_5000=generate_data_plots(datas_s2_second2_5000$dlong_list,n,r,p,k,2,0.7,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (not penalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(2.82e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second21_5000 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR1,p,k,R2,'5000SECOND21')
# 
# lambda_plot(find_lambda_s2_second21_5000)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND21",".rds")
find_lambda_s2_second21_5000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second21_5000)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second21_5000$results_df$lambda - lambda_plot(  find_lambda_s2_second21_5000)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_second21_5000$results_df$ave_lp[indexes])
```
#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(4.192e-4), log10(2.82e-3), n = 4)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second21_5000_2 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR1,p,k,R2,'5000SECOND21_2')
# 
# lambda_plot(find_lambda_s2_second21_5000_2)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND21_2",".rds")
find_lambda_s2_second21_5000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second21_5000_2)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second21_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_second21_5000_2)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_second21_5000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(7.913e-4), log10(2.82e-3), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second21_5000_3 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR1,p,k,R2,'5000SECOND21_3')
# 
# lambda_plot(find_lambda_s2_second21_5000_3)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND21_3",".rds")
find_lambda_s2_second21_5000_3 <- readRDS(file_name)


lambdas_second_21_5000=lambda_plot(find_lambda_s2_second21_5000_3,'Datasets simulated using rank 2, \n models fitted using rank 1')$lam_plot

```

```{r}
indexes=which(abs(find_lambda_s2_second21_5000_3$results_df$lambda -   0.001315541 ) < 1e-8)
mean(find_lambda_s2_second21_5000_3$results_df$ave_lp[indexes])
```
#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second21_5000)$lambda_opt
# 
# performance_results_s2_second21_5000 = simulations_fit_and_preformance(datas_s2_second2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'5000_SECOND21')
```



```{r}
file_name <- paste0("simulation_progress_exp5000_SECOND21_0.001315541",".rds")
performance_results_s2_second21_5000 <- readRDS(file_name)

performance_results_s2_second21_5000$bias3_df <- do.call(rbind, performance_results_s2_second21_5000$bias3_list)
performance_results_s2_second21_5000$mse3_df <- do.call(rbind, performance_results_s2_second21_5000$mse3_list)

colnames(performance_results_s2_second21_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second21_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second21_5000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second21_5000
title = "Fitted under rank 1"
Beta_true=second2_5000_beta_true
  
beta_heat2_5000_2_21=beta_heatmap(title,Beta_true, performance_results,-0.00166, 0.00975,minmax=TRUE)

```
##### Plot performance

```{r}
r_s2_second21_5000 = generate_histograms(performance_results_s2_second21_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_second21_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second21_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second21_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second21_5000$lp_errors, as.vector))

MC_error_lp_second21_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(6.02e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second22_5000 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR2,p,k,R2,'5000SECOND22')
# 
# 
# lambda_plot(find_lambda_s2_second22_5000)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND22",".rds")
find_lambda_s2_second22_5000 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second22_5000)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second22_5000$results_df$lambda - lambda_plot(  find_lambda_s2_second22_5000)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_second22_5000$results_df$ave_lp[indexes])
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.124e-4), log10(6.02e-3), n = 6)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second22_5000_2 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR2,p,k,R2,'5000SECOND22_2')
# 
# 
# lambda_plot(find_lambda_s2_second22_5000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND22_2",".rds")
find_lambda_s2_second22_5000_2 <- readRDS(file_name)

lambda_plot(find_lambda_s2_second22_5000_2)$lam_plot
```

```{r}
indexes=which(abs(find_lambda_s2_second22_5000_2$results_df$lambda - 0.001224798 ) < 1e-8)
mean(find_lambda_s2_second22_5000_2$results_df$ave_lp[indexes])
```

#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1.225e-3), log10(2.715e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second22_5000_3 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR2,p,k,R2,'5000SECOND22_3')
# 
# 
# lambda_plot(find_lambda_s2_second22_5000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND22_3",".rds")
find_lambda_s2_second22_5000_3 <- readRDS(file_name)

lambdas_second_22_5000=lambda_plot(find_lambda_s2_second22_5000_3,'Datasets simulated using rank 2, \n models fitted using rank 2')$lam_plot

```

```{r}
indexes=which(abs(find_lambda_s2_second22_5000_3$results_df$lambda -    lambda_plot(find_lambda_s2_second22_5000_3)$lambda_opt ) < 1e-8)
mean(find_lambda_s2_second22_5000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=0.001597156
#   
# performance_results_s2_second22_5000 = simulations_fit_and_preformance(datas_s2_second2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'5000_SECOND22_0.001597156')
```



```{r}
file_name <- paste0("simulation_progress_exp5000_SECOND22_0.001597156",".rds")
performance_results_s2_second22_5000 <- readRDS(file_name)

performance_results_s2_second22_5000$bias3_df <- do.call(rbind, performance_results_s2_second22_5000$bias3_list)
performance_results_s2_second22_5000$mse3_df <- do.call(rbind, performance_results_s2_second22_5000$mse3_list)

colnames(performance_results_s2_second22_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_second22_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_second22_5000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_second22_5000
title = "Fitted under rank 2"
Beta_true=second2_5000_beta_true
  
beta_heat2_5000_2_22=beta_heatmap(title,Beta_true, performance_results,-0.00166, 0.00975,minmax=TRUE)

```
##### Plot performance

```{r}
r_s2_second22_5000 = generate_histograms(performance_results_s2_second22_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_second22_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_second22_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_second22_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_second22_5000$lp_errors, as.vector))

MC_error_lp_second22_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```



#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(5.92e-3), n = 10)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second23_5000 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR3,p,k,R2,'5000SECOND23')
# 
# lambda_plot(find_lambda_s2_second23_5000)$lam_plot

```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND23_fixed",".rds")
# find_lambda_s2_second23_5000 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_second23_5000)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_second23_5000$results_df$lambda - lambda_plot(  find_lambda_s2_second23_5000)$lambda_opt ) < 1e-8)
# mean(find_lambda_s2_second23_5000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
#set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(8.105e-4), log10(5.92e-3), n = 4)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second23_5000_2 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR3,p,k,R2,'5000SECOND23_2')
# 
# lambda_plot(find_lambda_s2_second23_5000_2)$lam_plot

```

```{r}
# file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND23_2",".rds")
# find_lambda_s2_second23_5000_2 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_second23_5000_2)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_second23_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_second23_5000_2)$lambda_opt ) < 1e-8)
# mean(find_lambda_s2_second23_5000_2$results_df$ave_lp[indexes])
```
#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2y <- list()
# datasets_list_2y$dlong_list <- datas_s2_second2_5000$dlong_list[1:5]
# datasets_list_2y$Beta_matrix <- datas_s2_second2_5000$Beta_matrix
# datasets_list_2y$simulation_times <- datas_s2_second2_5000$simulation_times[1:5]
# datasets_list_2y$X_list <- datas_s2_second2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(8.105e-4), log10(3.051e-3), n = 6)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_second23_5000_3 = simulations_fit_find_best_lambda(datasets_list_2y,lambda_vector,Gamma.startR3,p,k,R2,'5000SECOND23_3')
# 
# lambda_plot(find_lambda_s2_second23_5000_3)$lam_plot

```


```{r}
# file_name <- paste0("simulation_lambdas_expfulldataset5000SECOND23_3",".rds")
# find_lambda_s2_second23_5000_3 <- readRDS(file_name)
# 
# lambda_plot(find_lambda_s2_second23_5000_3)$lam_plot
```


```{r}
# indexes=which(abs(find_lambda_s2_second23_5000_3$results_df$lambda - lambda_plot(  find_lambda_s2_second23_5000_3)$lambda_opt ) < 1e-8)
# mean(find_lambda_s2_second23_5000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=3

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# 
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_second23_5000)$lambda_opt
# 
# performance_results_s2_second23_5000 = simulations_fit_and_preformance(datas_s2_second2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR3, Print_flug,'5000_SECOND23')
```


##### Get average beta heatmap

```{r}
# performance_results=performance_results_s2_second23_5000
# title = "Fitted under rank 3"
# Beta_true=second2_5000_beta_true
#   
# beta_heat2_5000_2_23=beta_heatmap(title,Beta_true, performance_results)

```
##### Plot performance

```{r}
# r_s2_second23_5000 = generate_histograms(performance_results_s2_second23_5000, k)
```

##### ΜC ERRORS

```{r}

# msesmc = unlist(lapply(performance_results_s2_second23_5000$mse_for_all_coeffs, as.vector))
# biasmc = unlist(lapply(performance_results_s2_second23_5000$bias_for_all_coeffs, as.vector))
# MC_errors_s2_second23_5000 = MC_errors_calc(msesmc,biasmc)
```




##### LP ERRORS

```{r}
# lp_errors_mc = unlist(lapply(performance_results_s2_second23_5000$lp_errors, as.vector))
# 
# MC_error_lp_second23_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


### Heatmaps

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=heatmapreal2_2_1_5000
plot_listf1[[2]]=beta_heat2_5000_2_11
plot_listf1[[3]]=beta_heat2_5000_2_12
# plot_listf1[[4]]=NULL
plot_listf1[[4]]=heatmapreal2_2_2_5000
plot_listf1[[5]]=beta_heat2_5000_2_21
plot_listf1[[6]]=beta_heat2_5000_2_22
# plot_listf1[[8]]=NULL

top=''

heatmaps_2_5000 <- grid.arrange(grobs = plot_listf1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("heatmaps2_5000_2.png", plot = heatmaps_2_5000, width = 23, height = 6, dpi = 300)
```

### Lambda plots

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=lambdas_second_11_5000
plot_listf1[[2]]=lambdas_second_12_5000
plot_listf1[[3]]=lambdas_second_21_5000
plot_listf1[[4]]=lambdas_second_22_5000

top=''

lambdas_2_5000 <- grid.arrange(grobs = plot_listf1, ncol = 2, nrow = 2,top=top)

ggsave("lambdas_2_5000.png", plot = lambdas_2_5000, width = 17, height = 7, dpi = 300)
```

# THIRD Configuration (sample size:5000, p=300,K=8,n_simulation=100-randomly zeros in A and G and cor=0.1)

Fit only three unpenalized data to show that needs much time

## Call functions to simulate n_simulation=100 datasets using rank r=1 with random zeros

```{r}
#set seed
set.seed(123)
#chose variables
n = 5000   # Number of observations
p <- 300  # Number of covariates
k <- 8  # Number of outcomes
n_simulations = 100

r <- 1  # Rank of simulated data

datas_s2_third1_5000 = simulations_data(n,p,r,k,n_simulations,case =3,corr = 0.1)

rank_check(datas_s2_third1_5000$Beta_matrix)

third1_5000_beta_true=datas_s2_third1_5000$Beta_matrix

colnames(third1_5000_beta_true) <- paste("k=", 1:ncol(third1_5000_beta_true), sep="")
rownames(third1_5000_beta_true) <- paste("X", 1:nrow(third1_5000_beta_true), sep="")
beta_df <- reshape2::melt(third1_5000_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(third1_5000_beta_true), max(third1_5000_beta_true), length.out = 101)
breaks <- seq(-0.0113,0.00948, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_3_1_5000 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 1")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_third1_5000$dlong_list[1:5],n,r,p,k,
#                     T_sim=datas_s2_third1_5000$T_sim[1:5],
#                     T_obs=datas_s2_third1_5000$T_obs[1:5])

third_1_5000= generate_data_plots(datas_s2_third1_5000$dlong_list,n,r,p,k,3,0.1,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (no unpenalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_5000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_5000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_5000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(2.19e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third11_5000 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR1,p,k,R2,'5000THIRD11')
# lambda_plot(find_lambda_s2_third11_5000)$lam_plot
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD11",".rds")
find_lambda_s2_third11_5000 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third11_5000)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third11_5000$results_df$lambda - lambda_plot(  find_lambda_s2_third11_5000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third11_5000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_5000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_5000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_5000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(5.119580e-05), log10(2.19e-3), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third11_5000_2 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR1,p,k,R2,'5000THIRD11_2')
# lambda_plot(find_lambda_s2_third11_5000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD11_2",".rds")
find_lambda_s2_third11_5000_2 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third11_5000_2)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third11_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_third11_5000_2)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third11_5000_2$results_df$ave_lp[indexes])
```



#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_5000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_5000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_5000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(4.875e-4), log10(2.19e-3), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third11_5000_3 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR1,p,k,R2,'5000THIRD11_3')
# lambda_plot(find_lambda_s2_third11_5000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD11_3",".rds")
find_lambda_s2_third11_5000_3 <- readRDS(file_name)

lambdas_third_11_5000=lambda_plot(find_lambda_s2_third11_5000_3,'Datasets simulated using rank 1, \n models fitted using rank 1')$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third11_5000_3$results_df$lambda - lambda_plot(  find_lambda_s2_third11_5000_3)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third11_5000_3$results_df$ave_lp[indexes])
```


#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=0.001621624
#   
# performance_results_s2_third11_5000 = simulations_fit_and_preformance(datas_s2_third1_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'5000_THIRD11')
```


```{r}
file_name <- paste0("simulation_progress_exp5000_THIRD11_0.001621624",".rds")
performance_results_s2_third11_5000 <- readRDS(file_name)

performance_results_s2_third11_5000$bias3_df <- do.call(rbind, performance_results_s2_third11_5000$bias3_list)
performance_results_s2_third11_5000$mse3_df <- do.call(rbind, performance_results_s2_third11_5000$mse3_list)

colnames(performance_results_s2_third11_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third11_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third11_5000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third11_5000
title = "Fitted under rank 1"
Beta_true=third1_5000_beta_true
  
beta_heat2_5000_3_11=beta_heatmap(title,Beta_true, performance_results,-0.0113,0.00948,minmax = TRUE)

```

##### Plot performance

```{r}
r_s2_third11_5000 = generate_histograms(performance_results_s2_third11_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_third11_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third11_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third11_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third11_5000$lp_errors, as.vector))

MC_error_lp_third11_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda    #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_5000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_5000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_5000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(1e-10), log10(1.24e-3), n = 10)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third12_5000 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR2,p,k,R2,'5000THIRD12')
# lambda_plot(find_lambda_s2_third12_5000)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD12",".rds")
find_lambda_s2_third12_5000 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third12_5000)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third12_5000$results_df$lambda - lambda_plot(  find_lambda_s2_third12_5000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third12_5000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda    #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_5000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_5000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_5000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(2.019592e-04), log10(1.24e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third12_5000_2 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR2,p,k,R2,'5000THIRD12_2')
# lambda_plot(find_lambda_s2_third12_5000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD12_2",".rds")
find_lambda_s2_third12_5000_2 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third12_5000_2)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third12_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_third12_5000_2)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third12_5000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda    #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# datasets_list_f <- list()
# datasets_list_f$dlong_list <- datas_s2_third1_5000$dlong_list[1:5]
# datasets_list_f$Beta_matrix <- datas_s2_third1_5000$Beta_matrix
# datasets_list_f$simulation_times <- datas_s2_third1_5000$simulation_times[1:5]
# datasets_list_f$X_list <- datas_s2_third1_5000$X_list[1:5]
# 
# lambda_vector = logspace(log10(0.0006771772), log10(1.24e-3), n = 4)
# Gamma.startR2<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third12_5000_3 = simulations_fit_find_best_lambda(datasets_list_f,lambda_vector,Gamma.startR2,p,k,R2,'5000THIRD12_3')
# lambda_plot(find_lambda_s2_third12_5000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD12_3",".rds")
find_lambda_s2_third12_5000_3 <- readRDS(file_name)

lambdas_third_12_5000=lambda_plot(find_lambda_s2_third12_5000_3,'Datasets simulated using rank 1, \n models fitted using rank 2')$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third12_5000_3$results_df$lambda - lambda_plot(  find_lambda_s2_third12_5000_3)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third12_5000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=0.001013558
# 
# performance_results_s2_third12_5000 = simulations_fit_and_preformance(datas_s2_third1_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'5000_THIRD12_0.001013558')
```


```{r}
file_name <- paste0("simulation_progress_exp5000_THIRD12_0.001013558",".rds")
performance_results_s2_third12_5000 <- readRDS(file_name)

performance_results_s2_third12_5000$bias3_df <- do.call(rbind, performance_results_s2_third12_5000$bias3_list)
performance_results_s2_third12_5000$mse3_df <- do.call(rbind, performance_results_s2_third12_5000$mse3_list)

colnames(performance_results_s2_third12_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third12_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third12_5000$est_Gammamatrix_list, is.null))
```


##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third12_5000
title = "Fitted under rank 2"
Beta_true=third1_5000_beta_true
  
beta_heat2_5000_3_12=beta_heatmap(title,Beta_true, performance_results,-0.0113,0.00948,minmax = TRUE)

```


##### Plot performance

```{r}
r_s2_third12_5000 = generate_histograms(performance_results_s2_third12_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_third12_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third12_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third12_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third12_5000$lp_errors, as.vector))

MC_error_lp_third12_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


## Call functions to simulate n_simulation=100 datasets using rank r=2 with random zeros

```{r}
#set seed
set.seed(123)

r <- 2  # Rank of simulated data

datas_s2_third2_5000 = simulations_data(n,p,r,k,n_simulations,case=3,corr = 0.1)

rank_check(datas_s2_third2_5000$Beta_matrix)

third2_5000_beta_true=datas_s2_third2_5000$Beta_matrix

colnames(third2_5000_beta_true) <- paste("k=", 1:ncol(third2_5000_beta_true), sep="")
rownames(third2_5000_beta_true) <- paste("X", 1:nrow(third2_5000_beta_true), sep="")
beta_df <- reshape2::melt(third2_5000_beta_true)
my_palette <- colorRampPalette(c("lightgrey", "orange", "black"))(100)
# breaks <- seq(min(third2_5000_beta_true), max(third2_5000_beta_true), length.out = 101)
breaks <- seq(-2.208e-06,0.0163, length.out = 101)
norm_breaks <- (breaks - min(breaks)) / (max(breaks) - min(breaks))
heatmapreal2_3_2_5000 <- ggplot(beta_df, aes(x = Var2, y = Var1, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colors = my_palette, 
                       values = norm_breaks, # specify normalized breaks here
                       limits = range(breaks)) + # Set limits to the min and max of your breaks
  theme_minimal() +
  labs(x = "", y = "", fill = "Value") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 15),  
    axis.text.y = element_text(size = 1),                         
    axis.title.x = element_text(size = 15),                       
    axis.title.y = element_text(size = 15),                       
    legend.text = element_text(size = 20),                         
    legend.title = element_text(size = 20),                       
    plot.title = element_text(size = 30),           
    strip.text = element_text(size = 20)                           
  )+
  ggtitle("Simulated under rank 2")
```

### Generated Data Statistics Plots

```{r}
# generate_data_plots(datas_s2_third2_5000$dlong_list[1:5],n,r,p,k,
#                     T_sim=datas_s2_third2_5000$T_sim[1:5],
#                     T_obs=datas_s2_third2_5000$T_obs[1:5])

third_2_5000 = generate_data_plots(datas_s2_third2_5000$dlong_list,n,r,p,k,3,0.1,
                    T_sim=NULL,
                    T_obs=NULL)
```

### PENALISED FITTINGS (not penalised since need much time)

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_5000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_5000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_5000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(3.83e-3), n = 10)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third21_5000 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR1,p,k,R2,'5000THIRD21')
# lambda_plot(find_lambda_s2_third21_5000)$lam_plot
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD21",".rds")
find_lambda_s2_third21_5000 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third21_5000)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third21_5000$results_df$lambda - lambda_plot(  find_lambda_s2_third21_5000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third21_5000$results_df$ave_lp[indexes])
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_5000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_5000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_5000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(7.908e-5), log10(3.83e-3), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third21_5000_2 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR1,p,k,R2,'5000THIRD21_2')
# lambda_plot(find_lambda_s2_third21_5000_2)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD21_2",".rds")
find_lambda_s2_third21_5000_2 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third21_5000_2)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third21_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_third21_5000_2)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third21_5000_2$results_df$ave_lp[indexes])
```
#### --Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_5000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_5000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_5000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(8.112e-4), log10(3.83e-3), n = 6)
# Gamma.startR1<- matrix(rnorm(R2*k),R2,k)
# # 
# # find_lambda_s2_third21_5000_3 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR1,p,k,R2,'5000THIRD21_3')
# # lambda_plot(find_lambda_s2_third21_5000_3)$lam_plot
```



```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD21_3",".rds")
find_lambda_s2_third21_5000_3 <- readRDS(file_name)

lambdas_third_21_5000=lambda_plot(find_lambda_s2_third21_5000_3,'Datasets simulated using rank 2, \n models fitted using rank 1')$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third21_5000_3$results_df$lambda - lambda_plot(  find_lambda_s2_third21_5000_3)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third21_5000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=1

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 1 #rank of fitted model
# 
# 
# lambda_opt=0.001509233
# 
# performance_results_s2_third21_5000 = simulations_fit_and_preformance(datas_s2_third2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR1,Print_flug,'5000_THIRD21_0.001509233')
```



```{r}
file_name <- paste0("simulation_progress_exp5000_THIRD21_0.001509233",".rds")
performance_results_s2_third21_5000 <- readRDS(file_name)

performance_results_s2_third21_5000$bias3_df <- do.call(rbind, performance_results_s2_third21_5000$bias3_list)
performance_results_s2_third21_5000$mse3_df <- do.call(rbind, performance_results_s2_third21_5000$mse3_list)

colnames(performance_results_s2_third21_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third21_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third21_5000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third21_5000
title = "Fitted under rank 1"
Beta_true=third2_5000_beta_true
  
beta_heat2_5000_3_21=beta_heatmap(title,Beta_true, performance_results,-2.208e-06,0.0163,minmax=TRUE)

```

##### Plot performance

```{r}
r_s2_third21_5000 = generate_histograms(performance_results_s2_third21_5000, k)
```

##### ΜC ERRORS

```{r}

msesmc = unlist(lapply(performance_results_s2_third21_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third21_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third21_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third21_5000$lp_errors, as.vector))

MC_error_lp_third21_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```


#### Fit 5 first datasets to find best lambda   #okok

```{r}
#set seed
set.seed(123)

R2 = 2 #rank of fitted model
datasets_list_2f <- list()
datasets_list_2f$dlong_list <- datas_s2_third2_5000$dlong_list[1:5]
datasets_list_2f$Beta_matrix <- datas_s2_third2_5000$Beta_matrix
datasets_list_2f$simulation_times <- datas_s2_third2_5000$simulation_times[1:5]
datasets_list_2f$X_list <- datas_s2_third2_5000$X_list[1:5]


lambda_vector = logspace(log10(1e-10), log10(5.66e-3), n = 10)
Gamma.startR2<- matrix(rnorm(R2*k),R2,k)

find_lambda_s2_third22_5000 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR2,p,k,R2,'5000THIRD22')
lambda_plot(find_lambda_s2_third22_5000)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD22ALL",".rds")
find_lambda_s2_third22_5000 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third22_5000)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third22_5000$results_df$lambda - lambda_plot(  find_lambda_s2_third22_5000)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third22_5000$results_df$ave_lp[indexes])
```



#### Fit 5 first datasets to find best lambda   #okok

```{r}
#set seed
set.seed(123)

R2 = 2 #rank of fitted model
datasets_list_2f <- list()
datasets_list_2f$dlong_list <- datas_s2_third2_5000$dlong_list[1:5]
datasets_list_2f$Beta_matrix <- datas_s2_third2_5000$Beta_matrix
datasets_list_2f$simulation_times <- datas_s2_third2_5000$simulation_times[1:5]
datasets_list_2f$X_list <- datas_s2_third2_5000$X_list[1:5]


lambda_vector = logspace(log10(1.071e-4), log10(5.66e-3), n = 6)
Gamma.startR2<- matrix(rnorm(R2*k),R2,k)

find_lambda_s2_third22_5000_2 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR2,p,k,R2,'5000THIRD22_2')
lambda_plot(find_lambda_s2_third22_5000_2)$lam_plot
```

```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD22_2",".rds")
find_lambda_s2_third22_5000_2 <- readRDS(file_name)
lambda_plot(  find_lambda_s2_third22_5000_2)$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third22_5000_2$results_df$lambda - lambda_plot(  find_lambda_s2_third22_5000_2)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third22_5000_2$results_df$ave_lp[indexes])
```


#### --Fit 5 first datasets to find best lambda   #okok

```{r}
#set seed
set.seed(123)

R2 = 2 #rank of fitted model
datasets_list_2f <- list()
datasets_list_2f$dlong_list <- datas_s2_third2_5000$dlong_list[1:5]
datasets_list_2f$Beta_matrix <- datas_s2_third2_5000$Beta_matrix
datasets_list_2f$simulation_times <- datas_s2_third2_5000$simulation_times[1:5]
datasets_list_2f$X_list <- datas_s2_third2_5000$X_list[1:5]


lambda_vector = logspace(log10(1.158e-3), log10(5.66e-3), n = 6)
Gamma.startR2<- matrix(rnorm(R2*k),R2,k)

find_lambda_s2_third22_5000_3 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR2,p,k,R2,'5000THIRD22_3')
lambda_plot(find_lambda_s2_third22_5000_3)$lam_plot
```


```{r}
file_name <- paste0("simulation_lambdas_expfulldataset5000THIRD22_3",".rds")
find_lambda_s2_third22_5000_3 <- readRDS(file_name)

lambdas_third_22_5000=lambda_plot(find_lambda_s2_third22_5000_3,'Datasets simulated using rank 2, \n models fitted using rank 2')$lam_plot
```

```{r}

indexes=which(abs(find_lambda_s2_third22_5000_3$results_df$lambda - lambda_plot(  find_lambda_s2_third22_5000_3)$lambda_opt) < 1e-8)
mean(find_lambda_s2_third22_5000_3$results_df$ave_lp[indexes])
```

#### Fit simulated datasets with model of rank R2=2

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 2 #rank of fitted model
# 
# 
# lambda_opt=0.002184498
#   
# performance_results_s2_third22_5000 = simulations_fit_and_preformance(datas_s2_third2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR2,Print_flug,'5000_THIRD22')
```


```{r}
file_name <- paste0("simulation_progress_exp5000_THIRD22_0.002184498",".rds")
performance_results_s2_third22_5000 <- readRDS(file_name)

performance_results_s2_third22_5000$bias3_df <- do.call(rbind, performance_results_s2_third22_5000$bias3_list)
performance_results_s2_third22_5000$mse3_df <- do.call(rbind, performance_results_s2_third22_5000$mse3_list)

colnames(performance_results_s2_third22_5000$bias3_df) <- paste0("Outcome_", 1:k)
colnames(performance_results_s2_third22_5000$mse3_df) <- paste0("Outcome_", 1:k)

sum(sapply(performance_results_s2_third22_5000$est_Gammamatrix_list, is.null))
```



##### Get average beta heatmap

```{r}
performance_results=performance_results_s2_third22_5000
title = "Fitted under rank 2"
Beta_true=third2_5000_beta_true
  
beta_heat2_5000_3_22=beta_heatmap(title,Beta_true, performance_results,-2.208e-06,0.0163,minmax=TRUE)

```


##### Plot performance

```{r}
r_s2_third22_5000 = generate_histograms(performance_results_s2_third22_5000, k)
```

##### ΜC ERRORS

```{r}
msesmc = unlist(lapply(performance_results_s2_third22_5000$mse_for_all_coeffs, as.vector))
biasmc = unlist(lapply(performance_results_s2_third22_5000$bias_for_all_coeffs, as.vector))
MC_errors_s2_third22_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
lp_errors_mc = unlist(lapply(performance_results_s2_third22_5000$lp_errors, as.vector))

MC_error_lp_third22_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```

#### Fit 5 first datasets to find best lambda   #okok

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# datasets_list_2f <- list()
# datasets_list_2f$dlong_list <- datas_s2_third2_5000$dlong_list[1:5]
# datasets_list_2f$Beta_matrix <- datas_s2_third2_5000$Beta_matrix
# datasets_list_2f$simulation_times <- datas_s2_third2_5000$simulation_times[1:5]
# datasets_list_2f$X_list <- datas_s2_third2_5000$X_list[1:5]
# 
# 
# lambda_vector = logspace(log10(1e-10), log10(5.46e-3), n = 10)
# Gamma.startR3<- matrix(rnorm(R2*k),R2,k)
# 
# find_lambda_s2_third23_5000 = simulations_fit_find_best_lambda(datasets_list_2f,lambda_vector,Gamma.startR3,p,k,R2,'5000THIRD23')
# 
# 
# lambda_plot(find_lambda_s2_third23_5000)$lam_plot

```

#### Fit simulated datasets with model of rank R2=3

##### Get performance

```{r}
# #set seed
# set.seed(123)
# 
# R2 = 3 #rank of fitted model
# 
# 
# lambda_opt=lambda_plot(find_lambda_s2_third23_5000)$lambda_opt
# 
# performance_results_s2_third23_5000 = simulations_fit_and_preformance(datas_s2_third2_5000,p,k,R2,penalty_flug=TRUE,lambda_opt,lambda_opt,Gamma.startR3, Print_flug,'5000_THIRD23')
```


##### Get average beta heatmap

```{r}
# performance_results=performance_results_s2_third23_5000
# title = "Fitted under rank 3"
# Beta_true=third2_5000_beta_true
#   
# beta_heat2_5000_3_23=beta_heatmap(title,Beta_true, performance_results)

```


##### Plot performance

```{r}
# r_s2_third23_5000 = generate_histograms(simulations_fit_and_preformance, k)
```

##### ΜC ERRORS

```{r}
# msesmc = unlist(lapply(simulations_fit_and_preformance$mse_for_all_coeffs, as.vector))
# biasmc = unlist(lapply(simulations_fit_and_preformance$bias_for_all_coeffs, as.vector))
# MC_errors_s2_third23_5000 = MC_errors_calc(msesmc,biasmc)
```


##### LP ERRORS

```{r}
# lp_errors_mc = unlist(lapply(simulations_fit_and_preformance$lp_errors, as.vector))
# 
# MC_error_lp_third23_5000=sd(lp_errors_mc)/sqrt(length(lp_errors_mc))
```



### Heatmaps

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=heatmapreal2_3_1_5000
plot_listf1[[2]]=beta_heat2_5000_3_11
plot_listf1[[3]]=beta_heat2_5000_3_12
# plot_listf1[[4]]=NULL
plot_listf1[[4]]=heatmapreal2_3_2_5000
plot_listf1[[5]]=beta_heat2_5000_3_21
plot_listf1[[6]]=beta_heat2_5000_3_22
# plot_listf1[[8]]=NULL

top=''

heatmaps_3_5000 <- grid.arrange(grobs = plot_listf1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("heatmaps2_5000_3.png", plot = heatmaps_3_5000, width = 23, height = 6, dpi = 300)
```

### Lambda plots

```{r}
plot_listf1 <- list()
plot_listf1[[1]]=lambdas_third_11_5000
plot_listf1[[2]]=lambdas_third_12_5000
plot_listf1[[3]]=lambdas_third_21_5000
plot_listf1[[4]]=lambdas_third_22_5000

top=''

lambdas_3_5000 <- grid.arrange(grobs = plot_listf1, ncol = 2, nrow = 2,top=top)

ggsave("lambdas_3_5000.png", plot = lambdas_3_5000,  width = 17, height = 7, dpi = 300)
```
# Final plots


## Data
```{r}
plot_list1 <- list()
plot_list1[[1]]=first_1_1000
plot_list1[[2]]=second_1_1000
plot_list1[[3]]=third_1_1000

plot_list1[[4]]=first_1_5000
plot_list1[[5]]=second_1_5000
plot_list1[[6]]=third_1_5000


top=paste('Simulation study 2, 100 datasets simulated per scenario using rank 1')
top=''
combined_plots1 <- grid.arrange(grobs = plot_list1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("combined_plots2_1.png", plot = combined_plots1, width = 20, height = 7.5, dpi = 300)


plot_list1 <- list()
plot_list1[[1]]=first_2_1000
plot_list1[[2]]=second_2_1000
plot_list1[[3]]=third_2_1000

plot_list1[[4]]=first_2_5000
plot_list1[[5]]=second_2_5000
plot_list1[[6]]=third_2_5000

top=paste('Simulation study 2, 100 datasets simulated per scenario using rank 2')
top=''
combined_plots2 <- grid.arrange(grobs = plot_list1, ncol = 3, nrow = 2,top=top)

# Save the combined plot grid as a PNG
ggsave("combined_plots2_2.png", plot = combined_plots2, width = 20, height = 7.5, dpi = 300)
```

## MSE

```{r}
f_mean_mse = c(mean(performance_results_s2_first11_1000$mse1),
               mean(performance_results_s2_first12_1000$mse1),
               mean(performance_results_s2_first21_1000$mse1),
               mean(performance_results_s2_first22_1000$mse1),
               -1,

               mean(performance_results_s2_second11_1000$mse1),
               mean(performance_results_s2_second12_1000$mse1),
               mean(performance_results_s2_second21_1000$mse1),
               mean(performance_results_s2_second22_1000$mse1),
               mean(performance_results_s2_second23_1000$mse1),

               mean(performance_results_s2_first11_5000$mse1),
               mean(performance_results_s2_first12_5000$mse1),
               mean(performance_results_s2_first21_5000$mse1),
               mean(performance_results_s2_first22_5000$mse1),
               -1,
               
               mean(performance_results_s2_second11_5000$mse1),
               mean(performance_results_s2_second12_5000$mse1),
               mean(performance_results_s2_second21_5000$mse1),
               mean(performance_results_s2_second22_5000$mse1),
              -1
               
               
               )


f_mc_error_mse = c(MC_errors_s2_first11_1000$MC_error_mse,
                   MC_errors_s2_first12_1000$MC_error_mse,
                   MC_errors_s2_first21_1000$MC_error_mse,
                   MC_errors_s2_first22_1000$MC_error_mse,
                   -1,

                   MC_errors_s2_second11_1000$MC_error_mse,
                   MC_errors_s2_second12_1000$MC_error_mse,
                   MC_errors_s2_second21_1000$MC_error_mse,
                   MC_errors_s2_second22_1000$MC_error_mse,
                   MC_errors_s2_second23_1000$MC_error_mse,
                     
                   MC_errors_s2_first11_5000$MC_error_mse,
                   MC_errors_s2_first12_5000$MC_error_mse,
                   MC_errors_s2_first21_5000$MC_error_mse,
                   MC_errors_s2_first22_5000$MC_error_mse,
                   -1,

                   MC_errors_s2_second11_5000$MC_error_mse,
                   MC_errors_s2_second12_5000$MC_error_mse,
                   MC_errors_s2_second21_5000$MC_error_mse,
                   MC_errors_s2_second22_5000$MC_error_mse,
                   -1
                   )

 f_mean_mse_third  =  c(
               mean(performance_results_s2_third11_1000$mse1),
               mean(performance_results_s2_third12_1000$mse1),
               mean(performance_results_s2_third21_1000$mse1),
               mean(performance_results_s2_third22_1000$mse1),
              -1,
                
               mean(performance_results_s2_third11_5000$mse1),
               mean(performance_results_s2_third12_5000$mse1),
               mean(performance_results_s2_third21_5000$mse1),
               mean(performance_results_s2_third22_5000$mse1),
               -1
 )
               
               
               
 f_mc_error_mse_third = c(MC_errors_s2_third11_1000$MC_error_mse,
                   MC_errors_s2_third12_1000$MC_error_mse,
                   MC_errors_s2_third21_1000$MC_error_mse,
                   MC_errors_s2_third22_1000$MC_error_mse,
                   -1,
                   
                   MC_errors_s2_third11_5000$MC_error_mse,
                   MC_errors_s2_third12_5000$MC_error_mse,
                   MC_errors_s2_third21_5000$MC_error_mse,
                   MC_errors_s2_third22_5000$MC_error_mse,
                   -1
                   )

 
f_ci_lower_mse = f_mean_mse  - 1.96 *f_mc_error_mse
f_ci_upper_mse = f_mean_mse  + 1.96 *f_mc_error_mse

f_ci_lower_mse_third = f_mean_mse_third  - 1.96 *f_mc_error_mse_third
f_ci_upper_mse_third = f_mean_mse_third  + 1.96 *f_mc_error_mse_third
```

## BIAS

```{r}
f_mean_bias =  c(mean(performance_results_s2_first11_1000$bias1),
               mean(performance_results_s2_first12_1000$bias1),
               mean(performance_results_s2_first21_1000$bias1),
               mean(performance_results_s2_first22_1000$bias1),
               -1,

               mean(performance_results_s2_second11_1000$bias1),
               mean(performance_results_s2_second12_1000$bias1),
               mean(performance_results_s2_second21_1000$bias1),
               mean(performance_results_s2_second22_1000$bias1),
               mean(performance_results_s2_second23_1000$bias1),
                              
               mean(performance_results_s2_first11_5000$bias1),
               mean(performance_results_s2_first12_5000$bias1),
               mean(performance_results_s2_first21_5000$bias1),
               mean(performance_results_s2_first22_5000$bias1),
               -1,

               mean(performance_results_s2_second11_5000$bias1),
               mean(performance_results_s2_second12_5000$bias1),
               mean(performance_results_s2_second21_5000$bias1),
               mean(performance_results_s2_second22_5000$bias1),
               -1

               
               )

f_mc_error_bias =  c(MC_errors_s2_first11_1000$MC_error_bias,
                   MC_errors_s2_first12_1000$MC_error_bias,
                   MC_errors_s2_first21_1000$MC_error_bias,
                   MC_errors_s2_first22_1000$MC_error_bias,
                   -1,

                   MC_errors_s2_second11_1000$MC_error_bias,
                   MC_errors_s2_second12_1000$MC_error_bias,
                   MC_errors_s2_second21_1000$MC_error_bias,
                   MC_errors_s2_second22_1000$MC_error_bias,
                   MC_errors_s2_second23_1000$MC_error_bias,
                                  
                   MC_errors_s2_first11_5000$MC_error_bias,
                   MC_errors_s2_first12_5000$MC_error_bias,
                   MC_errors_s2_first21_5000$MC_error_bias,
                   MC_errors_s2_first22_5000$MC_error_bias,
                   -1,

                   MC_errors_s2_second11_5000$MC_error_bias,
                   MC_errors_s2_second12_5000$MC_error_bias,
                   MC_errors_s2_second21_5000$MC_error_bias,
                   MC_errors_s2_second22_5000$MC_error_bias,
                   -1

                   )


 f_mean_bias_third  =  c(
               mean(performance_results_s2_third11_1000$bias1),
               mean(performance_results_s2_third12_1000$bias1),
               mean(performance_results_s2_third21_1000$bias1),
               mean(performance_results_s2_third22_1000$bias1),
               -1,
               
               mean(performance_results_s2_third11_5000$bias1),
               mean(performance_results_s2_third12_5000$bias1),
               mean(performance_results_s2_third21_5000$bias1),
               mean(performance_results_s2_third22_5000$bias1),
               -1
               )

               
        f_mc_error_bias_third = c(MC_errors_s2_third11_1000$MC_error_bias,
                   MC_errors_s2_third12_1000$MC_error_bias,
                   MC_errors_s2_third21_1000$MC_error_bias,
                   MC_errors_s2_third22_1000$MC_error_bias,
                   -1,
                   
                   MC_errors_s2_third11_5000$MC_error_bias,
                   MC_errors_s2_third12_5000$MC_error_bias,
                   MC_errors_s2_third21_5000$MC_error_bias,
                   MC_errors_s2_third22_5000$MC_error_bias,
                   -1
                   )        
               

f_ci_lower_bias = f_mean_bias  - 1.96 *f_mc_error_bias
f_ci_upper_bias = f_mean_bias  + 1.96 *f_mc_error_bias

f_ci_lower_bias_third = f_mean_bias_third  - 1.96 *f_mc_error_bias_third
f_ci_upper_bias_third = f_mean_bias_third  + 1.96 *f_mc_error_bias_third
```



## LPE

```{r}
f_mean_LPE =  c(mean(unlist(lapply(performance_results_s2_first11_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_first12_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_first21_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_first22_1000$ave_lp_errors, as.vector))),
                -1,
                

               mean(unlist(lapply(performance_results_s2_second11_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_second12_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_second21_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_second22_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_second23_1000$ave_lp_errors, as.vector))),
                              
               mean(unlist(lapply(performance_results_s2_first11_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_first12_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_first21_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_first22_5000$ave_lp_errors, as.vector))),
                -1,
                

               mean(unlist(lapply(performance_results_s2_second11_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_second12_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_second21_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_second22_5000$ave_lp_errors, as.vector))),
                -1
               )


f_mc_error_LPE =  c(MC_error_lp_first11_1000,
                    MC_error_lp_first12_1000,
                    MC_error_lp_first21_1000,
                    MC_error_lp_first22_1000,
                    -1,
                    
                    MC_error_lp_second11_1000,
                     MC_error_lp_second12_1000,
                     MC_error_lp_second21_1000,
                     MC_error_lp_second22_1000,
                     MC_error_lp_second23_1000,
                                   
                    MC_error_lp_first11_5000,
                    MC_error_lp_first12_5000,
                    MC_error_lp_first21_5000,
                    MC_error_lp_first22_5000,
                    -1,
                    
                    MC_error_lp_second11_5000,
                     MC_error_lp_second12_5000,
                     MC_error_lp_second21_5000,
                     MC_error_lp_second22_5000,
                     -1)


               
 f_mean_LPE_third =  c(mean(unlist(lapply(performance_results_s2_third11_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_third12_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_third21_1000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_third22_1000$ave_lp_errors, as.vector))),
                -1,
                
                mean(unlist(lapply(performance_results_s2_third11_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_third12_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_third21_5000$ave_lp_errors, as.vector))),
                mean(unlist(lapply(performance_results_s2_third22_5000$ave_lp_errors, as.vector))),
                -1
                )
               
               
 f_mc_error_LPE_third= c(MC_error_lp_third11_1000,
                    MC_error_lp_third12_1000,
                    MC_error_lp_third21_1000,
                    MC_error_lp_third22_1000,
                    -1,
                    
                    MC_error_lp_third11_5000,
                    MC_error_lp_third12_5000,
                    MC_error_lp_third21_5000,
                    MC_error_lp_third22_5000,
                    -1
                    )

f_ci_lower_LPE = f_mean_LPE  - 1.96 *f_mc_error_LPE
f_ci_upper_LPE = f_mean_LPE  + 1.96 *f_mc_error_LPE

f_ci_lower_LPE_third = f_mean_LPE_third  - 1.96 * f_mc_error_LPE_third
f_ci_upper_LPE_third = f_mean_LPE_third  + 1.96 * f_mc_error_LPE_third
```

## Plot with Means and MC errors

```{r}
xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
results_final_mse <- data.frame(
  sample_size = c(rep(2500,10),rep(5000,10)),
  case = rep(c(1,2), times = 2, each = 5),
  correlation = rep(c(0.7,0.7), times = 2, each = 5), 
  ranks_simulate = c(rep(xvecs,4)), #1
  ranks_fit = c(rep(xvecf,4)), #2
  mean_mse = f_mean_mse,
  ci_lower = f_ci_lower_mse,
  ci_upper = f_ci_upper_mse
  
)


plotmse = ggplot(results_final_mse, aes(x = sample_size, y = mean_mse, color = factor(ranks_fit), shape = factor(ranks_simulate))) +
  geom_point(size = 2.5, alpha = 0.5,position = position_dodge(width = 1000))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 20, position = position_dodge(width = 1000)) +
   geom_vline(xintercept = c(2500, 5000), linetype = "dashed", color = "grey", linewidth = 0.55) +  # Add vertical lines
  facet_grid(case ~ correlation, labeller = label_both) +
  scale_x_continuous(breaks = c(2500, 5000), labels=c('1000', '5000')) +
  scale_y_continuous(breaks = pretty_breaks(n = 8), limits = c(0, max(results_final_mse$ci_upper))) +
  scale_color_manual(values = c("purple","#F8766D", "#00BA38"), name = "Ranks Fit") +
  scale_shape_manual(values = c(16, 17), name = "Ranks Simulate") +
  labs(
    x = "Sample size (n)",
    y = "Average MSE",
    title = "",
    subtitle = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 21), 
    axis.title.y = element_text(size = 21),  
    plot.title = element_text(hjust = 0.5, size = 20),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    strip.text = element_text(size = 21),
    legend.key.size = unit(0.1, "lines"),  #legend keys
    legend.text = element_text(size = 21),  #legend text
    legend.title = element_text(size = 21),  # legend title
    panel.grid.major.x = element_blank(),  # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linewidth = 0.5),  # Keep major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  )



xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
results_final_mse_third <- data.frame(
  sample_size = c(rep(2500,5),rep(5000,5)),
  case = rep(3,10),
  correlation = rep(0.1, 10), 
  ranks_simulate = c(rep(xvecs,2)), #1
  ranks_fit = c(rep(xvecf,2)), #2
  mean_mse_third = f_mean_mse_third,
  ci_lower = f_ci_lower_mse_third,
  ci_upper = f_ci_upper_mse_third
  
)


plotmse_third = ggplot(results_final_mse_third, aes(x = sample_size, y = mean_mse_third, color = factor(ranks_fit), shape = factor(ranks_simulate))) +
  geom_point(size = 2.5, alpha = 0.5,position = position_dodge(width = 1000))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 20, position = position_dodge(width = 1000)) +
   geom_vline(xintercept = c(2500, 5000), linetype = "dashed", color = "grey", linewidth = 0.55) +  # Add vertical lines
  facet_grid(case ~ correlation, labeller = label_both) +
  scale_x_continuous(breaks = c(2500, 5000), labels=c('1000', '5000')) +
  scale_y_continuous(breaks = pretty_breaks(n = 8), limits = c(0, max(results_final_mse_third$ci_upper))) +
  scale_color_manual(values = c("purple","#F8766D", "#00BA38"), name = "Ranks Fit") +
  scale_shape_manual(values = c(16, 17), name = "Ranks Simulate") +
  labs(
    x = "Sample size (n)",
    y = "Average MSE",
    title = "",
    subtitle = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 21), 
    axis.title.y = element_text(size = 21),  
    plot.title = element_text(hjust = 0.5, size = 20),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    strip.text = element_text(size = 21),
    legend.key.size = unit(0.1, "lines"),  #legend keys
    legend.text = element_text(size = 21),  #legend text
    legend.title = element_text(size = 21),  # legend title
    panel.grid.major.x = element_blank(),  # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linewidth = 0.5),  # Keep major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  )


combined_plot_mse <- plotmse + plotmse_third +
  plot_annotation(
    title = "Simulation study 2 results",
    subtitle = "Average MSE for different combinations of \n parameters with 95% Monte Carlo confidence intervals",
    theme = theme(
      plot.title = element_text(size = 30, hjust = 0.5),
      plot.subtitle = element_text(size = 21, hjust = 0.5)
    )
  ) +
  plot_layout(guides = "collect")










xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
results_final_bias <- data.frame(
  sample_size = c(rep(2500,10),rep(5000,10)),
  case = rep(c(1,2), times = 2, each = 5),
  correlation = rep(c(0.7, 0.7), times = 2, each = 5), 
  ranks_simulate = c(rep(xvecs,4)), #1
  ranks_fit = c(rep(xvecf,4)), #2
  mean_bias = f_mean_bias,
  ci_lower = f_ci_lower_bias,
  ci_upper = f_ci_upper_bias
)


plotbias = ggplot(results_final_bias, aes(x = sample_size, y = mean_bias, color = factor(ranks_fit), shape = factor(ranks_simulate))) +
  geom_point(size = 2.5, alpha = 0.5,position = position_dodge(width = 1000))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 20, position = position_dodge(width = 1000)) +
   geom_vline(xintercept = c(2500, 5000), linetype = "dashed", color = "grey", linewidth = 0.55) +  # Add vertical lines
  facet_grid(case ~ correlation, labeller = label_both) +
  scale_x_continuous(breaks = c(2500, 5000), labels=c('1000', '5000')) +
  scale_y_continuous(breaks = pretty_breaks(n = 8), limits = c(0, max(results_final_bias$ci_upper))) +
  scale_color_manual(values = c("purple","#F8766D", "#00BA38"), name = "Ranks Fit") +
  scale_shape_manual(values = c(16, 17), name = "Ranks Simulate") +
  labs(
    x = "Sample size (n)",
    y = "Average absolute bias",
    title = "",
    subtitle = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 21), 
    axis.title.y = element_text(size = 21),  
    plot.title = element_text(hjust = 0.5, size = 20),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    strip.text = element_text(size = 21),
    legend.key.size = unit(0.1, "lines"),  #legend keys
    legend.text = element_text(size = 21),  #legend text
    legend.title = element_text(size = 21),  # legend title
    panel.grid.major.x = element_blank(),  # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linewidth = 0.5),  # Keep major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  )





xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
results_final_bias_third <- data.frame(
  sample_size = c(rep(2500,5),rep(5000,5)),
  case = rep(3,10),
  correlation = rep(0.1, 10), 
  ranks_simulate = c(rep(xvecs,2)), #1
  ranks_fit = c(rep(xvecf,2)), #2
  mean_bias_third = f_mean_bias_third,
  ci_lower = f_ci_lower_bias_third,
  ci_upper = f_ci_upper_bias_third
  
)


plotbias_third = ggplot(results_final_bias_third, aes(x = sample_size, y = mean_bias_third, color = factor(ranks_fit), shape = factor(ranks_simulate))) +
  geom_point(size = 2.5, alpha = 0.5,position = position_dodge(width = 1000))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 20, position = position_dodge(width = 1000)) +
   geom_vline(xintercept = c(2500, 5000), linetype = "dashed", color = "grey", linewidth = 0.55) +  # Add vertical lines
  facet_grid(case ~ correlation, labeller = label_both) +
  scale_x_continuous(breaks = c(2500, 5000), labels=c('1000', '5000')) +
  scale_y_continuous(breaks = pretty_breaks(n = 8), limits = c(0, max(results_final_bias_third$ci_upper))) +
  scale_color_manual(values = c("purple","#F8766D", "#00BA38"), name = "Ranks Fit") +
  scale_shape_manual(values = c(16, 17), name = "Ranks Simulate") +
  labs(
    x = "Sample size (n)",
    y = "Average absolute buas",
    title = "",
    subtitle = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 21), 
    axis.title.y = element_text(size = 21),  
    plot.title = element_text(hjust = 0.5, size = 20),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    strip.text = element_text(size = 21),
    legend.key.size = unit(0.1, "lines"),  #legend keys
    legend.text = element_text(size = 21),  #legend text
    legend.title = element_text(size = 21),  # legend title
    panel.grid.major.x = element_blank(),  # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linewidth = 0.5),  # Keep major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  )



combined_plot_abs_bias <- plotbias + plotbias_third +
  plot_annotation(
    title = "",
    subtitle = "Average absolute bias for different combinations of \n parameters with 95% Monte Carlo confidence intervals",
    theme = theme(
      plot.title = element_text(size = 30, hjust = 0.5),
      plot.subtitle = element_text(size = 21, hjust = 0.5)
    )
  ) +
  plot_layout(guides = "collect")








xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
results_final_lpe <- data.frame(
  sample_size = c(rep(2500,10), rep(5000,10)),
  case = rep(c(1,2), times = 1, each = 5),
  correlation = rep(c(0.7, 0.7), times = 1, each = 5), 
  ranks_simulate = c(rep(xvecs,4)), #1
  ranks_fit = c(rep(xvecf,4)), #2
  mean_lpe = f_mean_LPE,
  ci_lower = f_ci_lower_LPE,
  ci_upper = f_ci_upper_LPE
  
)


plotLPE = ggplot(results_final_lpe, aes(x = sample_size, y = mean_lpe, color = factor(ranks_fit), shape = factor(ranks_simulate))) +
  geom_point(size = 2.5, alpha = 0.5,position = position_dodge(width = 1000))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 20, position = position_dodge(width = 1000)) +
   geom_vline(xintercept = c(2500, 5000), linetype = "dashed", color = "grey", linewidth = 0.55) +  # Add vertical lines
  facet_grid(case ~ correlation, labeller = label_both) +
  scale_x_continuous(breaks = c(2500, 5000), labels=c('1000', '5000')) +
  scale_y_continuous(breaks = pretty_breaks(n = 8), limits = c(0, max(results_final_lpe$ci_upper))) +
  scale_color_manual(values = c("purple","#F8766D", "#00BA38"), name = "Ranks Fit") +
  scale_shape_manual(values = c(16, 17), name = "Ranks Simulate") +
  labs(
    x = "Sample size (n)",
    y = "Average LPE",
    title = "",
    subtitle = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 21), 
    axis.title.y = element_text(size = 21),  
    plot.title = element_text(hjust = 0.5, size = 20),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    strip.text = element_text(size = 21),
    legend.key.size = unit(0.1, "lines"),  #legend keys
    legend.text = element_text(size = 21),  #legend text
    legend.title = element_text(size = 21),  # legend title
    panel.grid.major.x = element_blank(),  # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linewidth = 0.5),  # Keep major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  )







xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
results_final_LPE_third <- data.frame(
   sample_size = c(rep(2500,5),rep(5000,5)),
  case = rep(3,10),
  correlation = rep(0.1, 10), 
  ranks_simulate = c(rep(xvecs,2)), #1
  ranks_fit = c(rep(xvecf,2)), #2
  mean_LPE_third = f_mean_LPE_third,
  ci_lower = f_ci_lower_LPE_third,
  ci_upper = f_ci_upper_LPE_third
  
)

plotLPE_third = ggplot(results_final_LPE_third, aes(x = sample_size, y = mean_LPE_third, color = factor(ranks_fit), shape = factor(ranks_simulate))) +
  geom_point(size = 2.5, alpha = 0.5,position = position_dodge(width = 1000))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 20, position = position_dodge(width = 1000)) +
   geom_vline(xintercept = c(2500, 5000), linetype = "dashed", color = "grey", linewidth = 0.55) +  # Add vertical lines
  facet_grid(case ~ correlation, labeller = label_both) +
  scale_x_continuous(breaks = c(2500, 5000), labels=c('1000', '5000')) +
  scale_y_continuous(breaks = pretty_breaks(n = 8), limits = c(0, max(results_final_LPE_third$ci_upper))) +
  scale_color_manual(values = c("purple","#F8766D", "#00BA38"), name = "Ranks Fit") +
  scale_shape_manual(values = c(16, 17), name = "Ranks Simulate") +
  labs(
    x = "Sample size (n)",
    y = "Average LPE",
    title = "",
    subtitle = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12), 
    axis.title.x = element_text(size = 21), 
    axis.title.y = element_text(size = 21),  
    plot.title = element_text(hjust = 0.5, size = 20),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    strip.text = element_text(size = 21),
    legend.key.size = unit(0.1, "lines"),  #legend keys
    legend.text = element_text(size = 21),  #legend text
    legend.title = element_text(size = 21),  # legend title
    panel.grid.major.x = element_blank(),  # Remove major vertical grid lines
    panel.grid.minor.x = element_blank(),  # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linewidth = 0.5),  # Keep major horizontal grid lines
    panel.grid.minor.y = element_blank()  # Remove minor horizontal grid lines
  )



combined_plot_lpe <- plotLPE + plotLPE_third +
  plot_annotation(
    title = "",
    subtitle = "Average LPE for different combinations of \n parameters with 95% Monte Carlo confidence intervals",
    theme = theme(
      plot.title = element_text(size = 30, hjust = 0.5),
      plot.subtitle = element_text(size = 21, hjust = 0.5)
    )
  ) +
  plot_layout(guides = "collect")



ggsave("plotMSE2.png", plot = combined_plot_mse, width = 16, height = 6, dpi = 300)

ggsave("plotbias2.png", plot = combined_plot_abs_bias, width = 16, height = 6, dpi = 300)

ggsave("plotLPE2.png", plot = combined_plot_lpe, width = 16, height = 6, dpi = 300)


plotmse 
plotmse_third
plotbias
plotbias_third
plotLPE

combined_plot_mse
combined_plot_abs_bias
combined_plot_lpe
```


# Tables with Means and MC errors
```{r}
combine_simulation_results <- function(mse_df, bias_df, lp_df, mc_mse_df, mc_bias_df, mc_lp_df) {

  mse_df <- subset(mse_df, select = -c(ci_lower, ci_upper))
  bias_df <- subset(bias_df, select = -c(ci_lower, ci_upper))
  lp_df <- subset(lp_df, select = -c(ci_lower, ci_upper))
  

  names(mse_df)[names(mse_df) %in% c("mean_mse", "mean_mse_third")] <- "value"
  mse_df$metric <- "MSE"
  
  names(bias_df)[names(bias_df) %in% c("mean_bias", "mean_bias_third")] <- "value"
  bias_df$metric <- "ABSOLUTE BIAS"
  
  names(lp_df)[names(lp_df) %in% c("mean_lpe", "mean_LPE_third")] <- "value"
  lp_df$metric <- "LP ERROR"
  

  mse_df$mc_error <- mc_mse_df$mc_error_MSE
  bias_df$mc_error <- mc_bias_df$mc_error_bias
  lp_df$mc_error <- mc_lp_df$mc_error_LPE
  

  combined_df <- rbind(mse_df, bias_df, lp_df)

  combined_df <- combined_df[, c("sample_size", "case", "correlation", 
                                "ranks_simulate", "ranks_fit", "metric",
                                "value", "mc_error")]
  
  combined_df <- combined_df[order(combined_df$metric, 
                                 combined_df$sample_size,
                                 combined_df$case,
                                 combined_df$correlation,
                                 combined_df$ranks_simulate,
                                 combined_df$ranks_fit), ]
  
  return(combined_df)
}

```



```{r}
results_final_mc_mse <- data.frame(
  sample_size = c(rep(2500,10), rep(5000,10)),
  case = rep(c(1,2), times = 1, each = 5),
  correlation = rep(c(0.7, 0.7), times = 1, each = 5),
  ranks_simulate = c(rep(xvecs,4)), #1
  ranks_fit = c(rep(xvecf,4)), #2
  mc_error_MSE = f_mc_error_mse
)



results_final_mc_bias <- data.frame(
  sample_size = c(rep(2500,10), rep(5000,10)),
  case = rep(c(1,2), times = 1, each = 5),
  correlation = rep(c(0.7, 0.7), times = 1, each = 5),
  ranks_simulate = c(rep(xvecs,4)), #1
  ranks_fit = c(rep(xvecf,4)), #2
  mc_error_bias = f_mc_error_bias
)

results_final_mc_lpe <- data.frame(
  sample_size = c(rep(2500,10), rep(5000,10)),
  case = rep(c(1,2), times = 1, each = 5),
  correlation = rep(c(0.7, 0.7), times = 1, each = 5),
  ranks_simulate = c(rep(xvecs,4)), #1
  ranks_fit = c(rep(xvecf,4)), #2
  mc_error_LPE = f_mc_error_LPE
)





combined_results <- combine_simulation_results(
  results_final_mse,
  results_final_bias,
  results_final_lpe,
  results_final_mc_mse,
  results_final_mc_bias,
  results_final_mc_lpe
)

combined_results$sample_size[combined_results$sample_size == 2500] <- 1000

combined_results$value <- formatC(combined_results$value, format = "e", digits = 4)
combined_results$mc_error <- formatC(combined_results$mc_error, format = "e", digits = 4)

latex_table <- xtable(combined_results,digits = c(0, 0, 0, 1, 0, 0, 0, 4, 4))


print(latex_table, comment = FALSE, include.rownames = FALSE)
```

```{r}
results_final_mc_mse_third <- data.frame(
  sample_size = c(rep(2500,5),rep(5000,5)),
  case = rep(3,10),
  correlation = rep(0.1, 10), 
  ranks_simulate = c(rep(xvecs,2)), #1
  ranks_fit = c(rep(xvecf,2)), #2
  mc_error_MSE = f_mc_error_mse_third
)



results_final_mc_bias_third <- data.frame(
  sample_size = c(rep(2500,5),rep(5000,5)),
  case = rep(3,10),
  correlation = rep(0.1, 10), 
  ranks_simulate = c(rep(xvecs,2)), #1
  ranks_fit = c(rep(xvecf,2)), #2
  mc_error_bias = f_mc_error_bias_third
)

results_final_mc_lpe_third <- data.frame(
  sample_size = c(rep(2500,5),rep(5000,5)),
  case = rep(3,10),
  correlation = rep(0.1, 10), 
  ranks_simulate = c(rep(xvecs,2)), #1
  ranks_fit = c(rep(xvecf,2)), #2
  mc_error_LPE = f_mc_error_LPE_third
)


combined_results_third <- combine_simulation_results(
  results_final_mse_third,
  results_final_bias_third,
  results_final_LPE_third,
  results_final_mc_mse_third,
  results_final_mc_bias_third,
  results_final_mc_lpe_third
)

combined_results_third$sample_size[combined_results_third$sample_size == 2500] <- 1000

combined_results_third$value <- formatC(combined_results_third$value, format = "e", digits = 4)
combined_results_third$mc_error <- formatC(combined_results_third$mc_error, format = "e", digits = 4)

latex_table <- xtable(combined_results_third,digits = c(0, 0, 0, 1, 0, 0, 0, 4, 4))


print(latex_table, comment = FALSE, include.rownames = FALSE)
```

### B cor and LP cor

```{r}
B_mean_cor =  c(mean(performance_results_s2_first11_1000$cor_coeff_vec),
                 mean(performance_results_s2_first12_1000$cor_coeff_vec),
                 mean(performance_results_s2_first21_1000$cor_coeff_vec),
                 mean(performance_results_s2_first22_1000$cor_coeff_vec),
                 -1,
  
                 mean(performance_results_s2_second11_1000$cor_coeff_vec),
                 mean(performance_results_s2_second12_1000$cor_coeff_vec),
                 mean(performance_results_s2_second21_1000$cor_coeff_vec),
                 mean(performance_results_s2_second22_1000$cor_coeff_vec),
                 mean(performance_results_s2_second23_1000$cor_coeff_vec),
  
                
                mean(performance_results_s2_first11_5000$cor_coeff_vec),
                 mean(performance_results_s2_first12_5000$cor_coeff_vec),
                 mean(performance_results_s2_first21_5000$cor_coeff_vec),
                 mean(performance_results_s2_first22_5000$cor_coeff_vec),
                 -1,
  
                 mean(performance_results_s2_second11_5000$cor_coeff_vec),
                 mean(performance_results_s2_second12_5000$cor_coeff_vec),
                 mean(performance_results_s2_second21_5000$cor_coeff_vec),
                 mean(performance_results_s2_second22_5000$cor_coeff_vec),
                 -1)
  




lp_mean_cor =  c(mean(performance_results_s2_first11_1000$cor_lp),
                 mean(performance_results_s2_first12_1000$cor_lp),
                 mean(performance_results_s2_first21_1000$cor_lp),
                 mean(performance_results_s2_first22_1000$cor_lp),
                 -1,
  
                 mean(performance_results_s2_second11_1000$cor_lp),
                 mean(performance_results_s2_second12_1000$cor_lp),
                 mean(performance_results_s2_second21_1000$cor_lp),
                 mean(performance_results_s2_second22_1000$cor_lp),
                 mean(performance_results_s2_second23_1000$cor_lp),
  
                
                
                mean(performance_results_s2_first11_5000$cor_lp),
                 mean(performance_results_s2_first12_5000$cor_lp),
                 mean(performance_results_s2_first21_5000$cor_lp),
                 mean(performance_results_s2_first22_5000$cor_lp),
                 -1,
  
                 mean(performance_results_s2_second11_5000$cor_lp),
                 mean(performance_results_s2_second12_5000$cor_lp),
                 mean(performance_results_s2_second21_5000$cor_lp),
                 mean(performance_results_s2_second22_5000$cor_lp),
                 -1
)
  
              




B_sd_cor =  c(   sd(performance_results_s2_first11_1000$cor_coeff_vec),
                 sd(performance_results_s2_first12_1000$cor_coeff_vec),
                 sd(performance_results_s2_first21_1000$cor_coeff_vec),
                 sd(performance_results_s2_first22_1000$cor_coeff_vec),
                 -1,
  
                 sd(performance_results_s2_second11_1000$cor_coeff_vec),
                 sd(performance_results_s2_second12_1000$cor_coeff_vec),
                 sd(performance_results_s2_second21_1000$cor_coeff_vec),
                 sd(performance_results_s2_second22_1000$cor_coeff_vec),
                 sd(performance_results_s2_second23_1000$cor_coeff_vec),
  
                 
                
                sd(performance_results_s2_first11_5000$cor_coeff_vec),
                 sd(performance_results_s2_first12_5000$cor_coeff_vec),
                 sd(performance_results_s2_first21_5000$cor_coeff_vec),
                 sd(performance_results_s2_first22_5000$cor_coeff_vec),
                 -1,
  
                 sd(performance_results_s2_second11_5000$cor_coeff_vec),
                 sd(performance_results_s2_second12_5000$cor_coeff_vec),
                 sd(performance_results_s2_second21_5000$cor_coeff_vec),
                 sd(performance_results_s2_second22_5000$cor_coeff_vec),
                 -1
)
                



lp_sd_cor =  c(sd(performance_results_s2_first11_1000$cor_lp),
                 sd(performance_results_s2_first12_1000$cor_lp),
                 sd(performance_results_s2_first21_1000$cor_lp),
                 sd(performance_results_s2_first22_1000$cor_lp),
                 -1,
  
                 sd(performance_results_s2_second11_1000$cor_lp),
                 sd(performance_results_s2_second12_1000$cor_lp),
                 sd(performance_results_s2_second21_1000$cor_lp),
                 sd(performance_results_s2_second22_1000$cor_lp),
                 sd(performance_results_s2_second23_1000$cor_lp),
  
                
                sd(performance_results_s2_first11_5000$cor_lp),
                 sd(performance_results_s2_first12_5000$cor_lp),
                 sd(performance_results_s2_first21_5000$cor_lp),
                 sd(performance_results_s2_first22_5000$cor_lp),
                 -1,
  
                 sd(performance_results_s2_second11_5000$cor_lp),
                 sd(performance_results_s2_second12_5000$cor_lp),
                 sd(performance_results_s2_second21_5000$cor_lp),
                 sd(performance_results_s2_second22_5000$cor_lp),
                 -1
)



xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
table_final_b_lp_cor <- data.frame(
  sample_size = c(rep(2500,10), rep(5000,10)),
  case = rep(c(1,2), times = 1, each = 5),
  correlation = rep(c(0.7, 0.7), times = 1, each = 5), 
  ranks_simulate = c(rep(xvecs,4)), #1
  ranks_fit = c(rep(xvecf,4)), #2
  B_mean_cor = B_mean_cor,
  B_sd_cor = B_sd_cor,
  lp_mean_cor = lp_mean_cor,
  lp_sd_cor=lp_sd_cor
  
)
table_final_b_lp_cor$sample_size[table_final_b_lp_cor$sample_size == 2500] <- 1000
table_final_b_lp_cor$B_mean_cor <- formatC(table_final_b_lp_cor$B_mean_cor, format = "e", digits = 4)
table_final_b_lp_cor$B_sd_cor <- formatC(table_final_b_lp_cor$B_sd_cor , format = "e", digits = 4)
table_final_b_lp_cor$lp_mean_cor <- formatC(table_final_b_lp_cor$lp_mean_cor, format = "e", digits = 4)
table_final_b_lp_cor$lp_sd_cor <- formatC(table_final_b_lp_cor$lp_sd_cor, format = "e", digits = 4)

latex_table2 <- xtable(table_final_b_lp_cor,digits = c(0, 0, 0, 1, 0, 0, 4, 4, 4, 4))
print(latex_table2, comment = FALSE, include.rownames = FALSE)
```

```{r}
                
 B_mean_cor_third = c(mean(performance_results_s2_third11_1000$cor_coeff_vec),
                 mean(performance_results_s2_third12_1000$cor_coeff_vec),
                 mean(performance_results_s2_third21_1000$cor_coeff_vec),
                 mean(performance_results_s2_third22_1000$cor_coeff_vec),
                 -1,
                
                 mean(performance_results_s2_third11_5000$cor_coeff_vec),
                 mean(performance_results_s2_third12_5000$cor_coeff_vec),
                 mean(performance_results_s2_third21_5000$cor_coeff_vec),
                 mean(performance_results_s2_third22_5000$cor_coeff_vec),
                 -1
                )
 
 lp_mean_cor_third =  c(mean(performance_results_s2_third11_1000$cor_lp),
                 mean(performance_results_s2_third12_1000$cor_lp),
                 mean(performance_results_s2_third21_1000$cor_lp),
                 mean(performance_results_s2_third22_1000$cor_lp),
                 -1,
                
                
                 mean(performance_results_s2_third11_5000$cor_lp),
                 mean(performance_results_s2_third12_5000$cor_lp),
                 mean(performance_results_s2_third21_5000$cor_lp),
                 mean(performance_results_s2_third22_5000$cor_lp),
                 -1
                )

 B_sd_cor_third =  c(  sd(performance_results_s2_third11_1000$cor_coeff_vec),
                 sd(performance_results_s2_third12_1000$cor_coeff_vec),
                 sd(performance_results_s2_third21_1000$cor_coeff_vec),
                 sd(performance_results_s2_third22_1000$cor_coeff_vec),
                 -1,
                
  
                 sd(performance_results_s2_third11_5000$cor_coeff_vec),
                 sd(performance_results_s2_third12_5000$cor_coeff_vec),
                 sd(performance_results_s2_third21_5000$cor_coeff_vec),
                 sd(performance_results_s2_third22_5000$cor_coeff_vec),
                 -1
                )
 
  lp_sd_cor_third =  c(sd(performance_results_s2_third11_1000$cor_lp),
                 sd(performance_results_s2_third12_1000$cor_lp),
                 sd(performance_results_s2_third21_1000$cor_lp),
                 sd(performance_results_s2_third22_1000$cor_lp),
                 -1,
                 
                 sd(performance_results_s2_third11_5000$cor_lp),
                 sd(performance_results_s2_third12_5000$cor_lp),
                 sd(performance_results_s2_third21_5000$cor_lp),
                 sd(performance_results_s2_third22_5000$cor_lp),
                 -1
                )


xvecs = c(rep(1,2),rep(2,3))
xvecf = c(1,2,1,2,3)
table_final_b_lp_cor_third <- data.frame(
  sample_size = c(rep(2500,5),rep(5000,5)),
  case = rep(3,10),
  correlation = rep(0.1, 10), 
  ranks_simulate = c(rep(xvecs,2)), #1
  ranks_fit = c(rep(xvecf,2)), #2
  B_mean_cor = B_mean_cor_third,
  B_sd_cor = B_sd_cor_third,
  lp_mean_cor = lp_mean_cor_third,
  lp_sd_cor=lp_sd_cor_third
  
)
table_final_b_lp_cor_third$sample_size[table_final_b_lp_cor_third$sample_size == 2500] <- 1000

table_final_b_lp_cor_third$B_mean_cor <- formatC(table_final_b_lp_cor_third$B_mean_cor, format = "e", digits = 4)
table_final_b_lp_cor_third$B_sd_cor <- formatC(table_final_b_lp_cor_third$B_sd_cor , format = "e", digits = 4)
table_final_b_lp_cor_third$lp_mean_cor <- formatC(table_final_b_lp_cor_third$lp_mean_cor, format = "e", digits = 4)
table_final_b_lp_cor_third$lp_sd_cor <- formatC(table_final_b_lp_cor_third$lp_sd_cor, format = "e", digits = 4)

latex_table2 <- xtable(table_final_b_lp_cor_third,digits = c(0, 0, 0, 1, 0, 0, 4, 4, 4, 4))
print(latex_table2, comment = FALSE, include.rownames = FALSE)
```

